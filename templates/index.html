<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Documentary Production App</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Configure marked for better rendering
        marked.setOptions({
            breaks: true,
            gfm: true
        });
        // Custom renderer to open links in new tab
        const renderer = new marked.Renderer();
        renderer.link = function(href, title, text) {
            const titleAttr = title ? ` title="${title}"` : '';
            return `<a href="${href}"${titleAttr} target="_blank" rel="noopener noreferrer">${text}</a>`;
        };
        marked.use({ renderer });
    </script>
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- Header -->
            <header class="header">
                <div class="header-top">
                    <h1>üìΩÔ∏è Documentary Production</h1>
                    <div class="header-actions">
                        <button class="header-btn" onclick="toggleTheme()" id="theme-btn" title="Toggle dark/light mode">üåô</button>
                        <button class="header-btn" onclick="showProjectsModal()">üìÅ Projects</button>
                    </div>
                </div>
                <p id="project-name" class="project-name-clickable" onclick="showProjectsModal()">Loading...</p>
            </header>

            <!-- Main Content -->
            <main class="content" id="content">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading project data...</p>
                </div>
            </main>

            <!-- Bottom Navigation -->
            <nav class="nav" id="nav"></nav>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Modal</h3>
                <button onclick="closeModal()" class="close-btn">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ú® AI Assistant</h3>
                <button onclick="closeAIModal()" class="close-btn">&times;</button>
            </div>
            <div id="ai-modal-content"></div>
        </div>
    </div>

    <!-- Projects Modal -->
    <div id="projects-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÅ Projects</h3>
                <button onclick="closeProjectsModal()" class="close-btn">&times;</button>
            </div>
            <div id="projects-modal-content"></div>
        </div>
    </div>

    <script>
        // App State
        const state = {
            activeTab: 'dashboard',
            allProjects: [],
            selectedProject: null,
            project: null,
            episodes: [],
            research: [],
            interviews: [],
            shots: [],
            assets: [],
            scripts: [],
            loading: false
        };

        // Navigation items
        const navItems = [
            { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
            { id: 'episodes', icon: 'üìù', label: 'Episodes' },
            { id: 'research', icon: 'üîç', label: 'Research' },
            { id: 'interviews', icon: 'üë•', label: 'Interviews' },
            { id: 'production', icon: 'üé¨', label: 'Production' },
            { id: 'assets', icon: 'üì¶', label: 'Assets' },
            { id: 'scripts', icon: 'üìÑ', label: 'Scripts' }
        ];

        // ============== API Functions ==============

        async function api(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data) options.body = JSON.stringify(data);

            const response = await fetch(endpoint, options);
            return response.json();
        }

        async function loadProjectData() {
            try {
                // Get projects
                let projects = await api('/api/projects');

                state.allProjects = projects || [];

                // If no projects, show empty state
                if (!projects || projects.length === 0) {
                    state.selectedProject = null;
                    state.project = null;
                    state.episodes = [];
                    state.research = [];
                    state.interviews = [];
                    state.shots = [];
                    state.assets = [];
                    state.scripts = [];
                    document.getElementById('project-name').textContent = 'No projects';
                    renderEmptyState();
                    renderNav();
                    return;
                }

                // Use previously selected project or default to first
                if (!state.selectedProject || !projects.find(p => p.id === state.selectedProject)) {
                    state.selectedProject = projects[0].id;
                }
                state.project = projects.find(p => p.id === state.selectedProject);
                document.getElementById('project-name').textContent = state.project.title + ' ‚ñº';

                // Load all related data
                const [episodes, research, interviews, shots, assets, scripts] = await Promise.all([
                    api(`/api/projects/${state.selectedProject}/episodes`),
                    api(`/api/projects/${state.selectedProject}/research`),
                    api(`/api/projects/${state.selectedProject}/interviews`),
                    api(`/api/projects/${state.selectedProject}/shots`),
                    api(`/api/projects/${state.selectedProject}/assets`),
                    api(`/api/projects/${state.selectedProject}/scripts`)
                ]);

                state.episodes = episodes || [];
                state.research = research || [];
                state.interviews = interviews || [];
                state.shots = shots || [];
                state.assets = assets || [];
                state.scripts = scripts || [];

                renderNav();
                render();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card error-card">
                        <h3>Error Loading Data</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadProjectData()">Retry</button>
                    </div>
                `;
            }
        }

        function renderEmptyState() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìΩÔ∏è</div>
                    <h2>Welcome to Documentary Production</h2>
                    <p>Get started by creating your first documentary project.</p>
                    <button class="btn btn-primary btn-lg" onclick="showNewProjectModal()">
                        + Create New Project
                    </button>
                </div>
            `;
        }

        function showNewProjectModal() {
            const modal = document.getElementById('projects-modal');
            const content = document.getElementById('projects-modal-content');

            content.innerHTML = `
                <div id="new-project-form">
                    <p class="text-muted mb-3">Create your first documentary project to get started.</p>

                    <div class="project-create-tabs">
                        <button type="button" class="tab-btn active" onclick="switchProjectTab('manual')">Manual Entry</button>
                        <button type="button" class="tab-btn" onclick="switchProjectTab('blueprint')">From Blueprint</button>
                    </div>

                    <div id="manual-entry-tab" class="project-tab-content active">
                        <form onsubmit="createNewProject(event)">
                            <div class="input-with-mic">
                                <input type="text" id="new-project-title" placeholder="Project title" required>
                                <button type="button" class="mic-btn" data-for="new-project-title" onclick="toggleSpeech('new-project-title')" title="Speak">üé§</button>
                            </div>
                            <div class="input-with-mic">
                                <textarea id="new-project-description" placeholder="Brief description of your documentary" rows="3"></textarea>
                                <button type="button" class="mic-btn" data-for="new-project-description" onclick="toggleSpeech('new-project-description')" title="Speak">üé§</button>
                            </div>
                            <div class="input-with-mic">
                                <textarea id="new-project-style" placeholder="Documentary style (e.g., investigative journalism, personal narrative, observational, educational, cinematic)" rows="2"></textarea>
                                <button type="button" class="mic-btn" data-for="new-project-style" onclick="toggleSpeech('new-project-style')" title="Speak">üé§</button>
                            </div>
                            <select id="new-project-status">
                                <option value="Planning">Planning</option>
                                <option value="Research">Research</option>
                                <option value="In Production">In Production</option>
                                <option value="Post-Production">Post-Production</option>
                            </select>
                            <div class="episode-count-field">
                                <label for="new-project-episodes">Number of episodes to generate:</label>
                                <input type="number" id="new-project-episodes" min="1" max="20" value="5">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeProjectsModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Create Project</button>
                            </div>
                        </form>
                    </div>

                    <div id="blueprint-tab" class="project-tab-content">
                        <form onsubmit="createProjectFromBlueprint(event)">
                            <div class="blueprint-upload-area" onclick="document.getElementById('blueprint-file').click()">
                                <div class="upload-icon">üìÑ</div>
                                <p class="upload-text">Click to upload a blueprint</p>
                                <p class="upload-hint">Document (PDF, TXT) or Video (MP4, MOV)</p>
                                <input type="file" id="blueprint-file" accept=".pdf,.txt,.doc,.docx,.mp4,.mov,.avi,.mkv,.webm" onchange="handleBlueprintSelect(this)" style="display:none">
                            </div>
                            <div id="blueprint-file-info" class="blueprint-file-info" style="display:none">
                                <span id="blueprint-filename"></span>
                                <button type="button" class="btn-icon" onclick="clearBlueprintFile()">‚úï</button>
                            </div>
                            <div class="episode-count-field">
                                <label for="blueprint-episodes">Number of episodes to generate:</label>
                                <input type="number" id="blueprint-episodes" min="1" max="20" value="5">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeProjectsModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary" id="blueprint-submit-btn" disabled>Analyze & Create</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function switchProjectTab(tab) {
            document.querySelectorAll('.project-create-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.project-tab-content').forEach(content => content.classList.remove('active'));

            if (tab === 'manual') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('manual-entry-tab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('blueprint-tab').classList.add('active');
            }
        }

        function handleBlueprintSelect(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('blueprint-file-info').style.display = 'flex';
                document.getElementById('blueprint-filename').textContent = file.name;
                document.getElementById('blueprint-submit-btn').disabled = false;
                document.querySelector('.blueprint-upload-area').style.display = 'none';
            }
        }

        function clearBlueprintFile() {
            document.getElementById('blueprint-file').value = '';
            document.getElementById('blueprint-file-info').style.display = 'none';
            document.getElementById('blueprint-submit-btn').disabled = true;
            document.querySelector('.blueprint-upload-area').style.display = 'block';
        }

        async function createProjectFromBlueprint(event) {
            event.preventDefault();

            const fileInput = document.getElementById('blueprint-file');
            const file = fileInput.files[0];
            if (!file) return;

            const numEpisodes = parseInt(document.getElementById('blueprint-episodes').value) || 5;
            const submitBtn = document.getElementById('blueprint-submit-btn');

            submitBtn.disabled = true;

            try {
                let data;
                const LARGE_FILE_THRESHOLD = 30 * 1024 * 1024; // 30MB

                if (file.size > LARGE_FILE_THRESHOLD) {
                    // Large file: upload to GCS first, then analyze
                    submitBtn.innerHTML = '<span class="spinner-small"></span> Uploading large file...';

                    // Step 1: Get signed upload URL
                    const signedUrlResponse = await fetch('/api/upload/signed-url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: file.name,
                            contentType: file.type || 'video/mp4',
                            fileSize: file.size
                        })
                    });
                    const signedUrlData = await signedUrlResponse.json();

                    if (signedUrlData.error) {
                        throw new Error(signedUrlData.error);
                    }

                    // Step 2: Upload file directly to GCS
                    submitBtn.innerHTML = '<span class="spinner-small"></span> Uploading (' + formatFileSize(file.size) + ')...';

                    const uploadResponse = await fetch(signedUrlData.uploadUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': file.type || 'video/mp4' },
                        body: file
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Failed to upload file to storage');
                    }

                    // Step 3: Analyze from GCS
                    submitBtn.innerHTML = '<span class="spinner-small"></span> Analyzing video...';

                    const analyzeResponse = await fetch('/api/ai/analyze-blueprint', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            gcsUri: signedUrlData.gcsUri,
                            filename: file.name,
                            numEpisodes: numEpisodes
                        })
                    });
                    data = await analyzeResponse.json();

                } else {
                    // Small file: direct upload
                    submitBtn.innerHTML = '<span class="spinner-small"></span> Analyzing...';

                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('numEpisodes', numEpisodes);

                    const response = await fetch('/api/ai/analyze-blueprint', {
                        method: 'POST',
                        body: formData
                    });
                    data = await response.json();
                }

                if (data.error) {
                    throw new Error(data.error);
                }

                const blueprint = data.blueprint;

                // Create the project with extracted data (including blueprint file if present)
                const projectData = {
                    title: blueprint.title,
                    description: blueprint.description,
                    style: blueprint.style,
                    status: 'Planning'
                };

                if (blueprint.blueprintFile) {
                    projectData.blueprintFile = blueprint.blueprintFile;
                }

                const newProject = await api('/api/projects', 'POST', projectData);

                state.selectedProject = newProject.id;
                closeProjectsModal();
                await loadProjectData();

                // Show the extracted episodes for confirmation
                showBlueprintEpisodes(newProject.id, blueprint);

            } catch (error) {
                alert('Error analyzing blueprint: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Analyze & Create';
            }
        }

        function showBlueprintEpisodes(projectId, blueprint) {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            content.innerHTML = `
                <div class="ai-section">
                    <h4>üìã Blueprint Analysis Complete</h4>
                    <p class="text-sm text-muted mb-3">Project created: <strong>${blueprint.title}</strong></p>
                    <p class="text-sm mb-3"><em>Style: ${blueprint.style}</em></p>

                    <h5 class="mb-2">Suggested Episodes:</h5>
                    <div class="topic-list">
                        ${blueprint.episodes.map((ep, i) => `
                            <label class="topic-item">
                                <input type="checkbox" checked data-topic-index="${i}"
                                       data-title="${ep.title?.replace(/"/g, '&quot;') || ''}"
                                       data-description="${ep.description?.replace(/"/g, '&quot;') || ''}"
                                       data-order="${ep.order || i + 1}">
                                <div>
                                    <strong>${ep.title}</strong>
                                    <p class="text-sm text-muted">${ep.description}</p>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    <div class="form-actions mt-3">
                        <button class="btn btn-secondary" onclick="closeAIModal()">Skip Episodes</button>
                        <button class="btn btn-primary" onclick="createBlueprintEpisodes('${projectId}')">Create Selected</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        async function createBlueprintEpisodes(projectId) {
            const checkboxes = document.querySelectorAll('.topic-list input[type="checkbox"]:checked');
            const episodes = Array.from(checkboxes).map(cb => ({
                title: cb.dataset.title,
                description: cb.dataset.description,
                order: parseInt(cb.dataset.order),
                status: 'Planning',
                projectId: projectId
            }));

            if (episodes.length === 0) {
                closeAIModal();
                return;
            }

            const content = document.getElementById('ai-modal-content');
            content.innerHTML = `
                <div class="ai-section">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Creating ${episodes.length} episodes...</p>
                    </div>
                </div>
            `;

            try {
                for (const episode of episodes) {
                    await api('/api/episodes', 'POST', episode);
                }
                await loadProjectData();
                closeAIModal();
            } catch (error) {
                alert('Error creating episodes: ' + error.message);
                closeAIModal();
            }
        }

        // ============== Project Management ==============

        function showProjectsModal() {
            const modal = document.getElementById('projects-modal');
            const content = document.getElementById('projects-modal-content');

            content.innerHTML = `
                <div class="projects-list">
                    ${state.allProjects.map(p => `
                        <div class="project-item ${p.id === state.selectedProject ? 'active' : ''}">
                            <div class="project-item-info" onclick="switchProject('${p.id}')">
                                <h4>${p.title}</h4>
                                <p>${p.description || 'No description'}</p>
                                <span class="badge badge-blue">${p.status || 'Active'}</span>
                            </div>
                            <div class="project-item-actions">
                                ${p.id === state.selectedProject ? '<span class="project-active-badge">‚úì Active</span>' : ''}
                                <button class="btn-icon delete-project-btn" onclick="deleteProject('${p.id}', '${p.title.replace(/'/g, "\\'")}')" title="Delete project">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="projects-actions">
                    <button class="btn btn-primary" onclick="showNewProjectForm()">+ New Project</button>
                </div>
                <div id="new-project-form" style="display: none;">
                    <h4 class="mt-3 mb-2">Create New Project</h4>

                    <div class="project-create-tabs">
                        <button type="button" class="tab-btn active" onclick="switchProjectTab('manual')">Manual Entry</button>
                        <button type="button" class="tab-btn" onclick="switchProjectTab('blueprint')">From Blueprint</button>
                    </div>

                    <div id="manual-entry-tab" class="project-tab-content active">
                        <form onsubmit="createNewProject(event)">
                            <div class="input-with-mic">
                                <input type="text" id="new-project-title" placeholder="Project title" required>
                                <button type="button" class="mic-btn" data-for="new-project-title" onclick="toggleSpeech('new-project-title')" title="Speak">üé§</button>
                            </div>
                            <div class="input-with-mic">
                                <textarea id="new-project-description" placeholder="Brief description of your documentary" rows="3"></textarea>
                                <button type="button" class="mic-btn" data-for="new-project-description" onclick="toggleSpeech('new-project-description')" title="Speak">üé§</button>
                            </div>
                            <div class="input-with-mic">
                                <textarea id="new-project-style" placeholder="Documentary style (e.g., investigative journalism, personal narrative, observational, educational, cinematic)" rows="2"></textarea>
                                <button type="button" class="mic-btn" data-for="new-project-style" onclick="toggleSpeech('new-project-style')" title="Speak">üé§</button>
                            </div>
                            <select id="new-project-status">
                                <option value="Planning">Planning</option>
                                <option value="Research">Research</option>
                                <option value="In Production">In Production</option>
                                <option value="Post-Production">Post-Production</option>
                            </select>
                            <div class="episode-count-field">
                                <label for="new-project-episodes">Number of episodes to generate:</label>
                                <input type="number" id="new-project-episodes" min="1" max="20" value="5">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="hideNewProjectForm()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Create Project</button>
                            </div>
                        </form>
                    </div>

                    <div id="blueprint-tab" class="project-tab-content">
                        <form onsubmit="createProjectFromBlueprint(event)">
                            <div class="blueprint-upload-area" onclick="document.getElementById('blueprint-file').click()">
                                <div class="upload-icon">üìÑ</div>
                                <p class="upload-text">Click to upload a blueprint</p>
                                <p class="upload-hint">Document (PDF, TXT) or Video (MP4, MOV)</p>
                                <input type="file" id="blueprint-file" accept=".pdf,.txt,.doc,.docx,.mp4,.mov,.avi,.mkv,.webm" onchange="handleBlueprintSelect(this)" style="display:none">
                            </div>
                            <div id="blueprint-file-info" class="blueprint-file-info" style="display:none">
                                <span id="blueprint-filename"></span>
                                <button type="button" class="btn-icon" onclick="clearBlueprintFile()">‚úï</button>
                            </div>
                            <div class="episode-count-field">
                                <label for="blueprint-episodes">Number of episodes to generate:</label>
                                <input type="number" id="blueprint-episodes" min="1" max="20" value="5">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="hideNewProjectForm()">Cancel</button>
                                <button type="submit" class="btn btn-primary" id="blueprint-submit-btn" disabled>Analyze & Create</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeProjectsModal() {
            document.getElementById('projects-modal').classList.remove('active');
        }

        function showNewProjectForm() {
            document.getElementById('new-project-form').style.display = 'block';
        }

        function hideNewProjectForm() {
            document.getElementById('new-project-form').style.display = 'none';
        }

        async function switchProject(projectId) {
            state.selectedProject = projectId;
            closeProjectsModal();
            await loadProjectData();
        }

        async function createNewProject(event) {
            event.preventDefault();

            const title = document.getElementById('new-project-title').value;
            const description = document.getElementById('new-project-description').value;
            const style = document.getElementById('new-project-style').value;
            const status = document.getElementById('new-project-status').value;
            const numEpisodes = parseInt(document.getElementById('new-project-episodes').value) || 5;

            try {
                const newProject = await api('/api/projects', 'POST', {
                    title,
                    description,
                    style,
                    status
                });

                state.selectedProject = newProject.id;
                closeProjectsModal();
                await loadProjectData();

                // Generate episode topics for the new project
                showTopicSuggestions(newProject.id, title, description, style, numEpisodes);
            } catch (error) {
                alert('Error creating project: ' + error.message);
            }
        }

        async function showTopicSuggestions(projectId, title, description, style = '', numEpisodes = 5) {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            content.innerHTML = `
                <div class="ai-section">
                    <h4>‚ú® Generating ${numEpisodes} Episode Ideas...</h4>
                    <p class="text-sm text-muted mb-3">Based on your project${style ? ' and style' : ''}, we're suggesting episode topics.</p>
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Analyzing "${title}"...</p>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            try {
                const response = await api('/api/ai/generate-topics', 'POST', {
                    title,
                    description,
                    style,
                    numTopics: numEpisodes
                });

                if (response.topics && response.topics.length > 0) {
                    content.innerHTML = `
                        <div class="ai-section">
                            <h4>üìù Suggested Episodes</h4>
                            <p class="text-sm text-muted mb-3">Select which episodes to create for your documentary.</p>
                            <div class="topic-list">
                                ${response.topics.map((topic, i) => `
                                    <label class="topic-item">
                                        <input type="checkbox" checked data-topic-index="${i}"
                                               data-title="${topic.title?.replace(/"/g, '&quot;') || ''}"
                                               data-description="${topic.description?.replace(/"/g, '&quot;') || ''}">
                                        <div class="topic-content">
                                            <div class="topic-title">${topic.title || 'Episode ' + (i+1)}</div>
                                            <div class="topic-description">${topic.description || ''}</div>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                            <div class="form-actions mt-3">
                                <button class="btn btn-secondary" onclick="closeAIModal()">Skip</button>
                                <button class="btn btn-primary" onclick="createSelectedEpisodes('${projectId}')">Create Selected Episodes</button>
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="ai-section">
                            <h4>üìù Episode Ideas</h4>
                            <p class="text-muted">Could not generate suggestions. You can add episodes manually.</p>
                            ${response.error ? `<p class="text-sm text-muted">Error: ${response.error}</p>` : ''}
                            <button class="btn btn-primary mt-3" onclick="closeAIModal()">Continue</button>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="ai-section">
                        <h4>üìù Episode Ideas</h4>
                        <p class="text-muted">Could not generate suggestions: ${error.message}</p>
                        <button class="btn btn-primary mt-3" onclick="closeAIModal()">Continue</button>
                    </div>
                `;
            }
        }

        async function createSelectedEpisodes(projectId) {
            const checkboxes = document.querySelectorAll('.topic-list input[type="checkbox"]:checked');
            const episodes = [];

            checkboxes.forEach((cb, index) => {
                episodes.push({
                    projectId: projectId,
                    title: cb.dataset.title,
                    description: cb.dataset.description,
                    status: 'Planning',
                    duration: '45 min'
                });
            });

            if (episodes.length === 0) {
                closeAIModal();
                return;
            }

            // Show loading
            const content = document.getElementById('ai-modal-content');
            content.innerHTML = `
                <div class="ai-section">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Creating ${episodes.length} episode(s)...</p>
                    </div>
                </div>
            `;

            try {
                // Create episodes sequentially
                for (const episode of episodes) {
                    await api('/api/episodes', 'POST', episode);
                }

                closeAIModal();
                state.activeTab = 'episodes';
                await loadProjectData();
            } catch (error) {
                alert('Error creating episodes: ' + error.message);
                closeAIModal();
            }
        }

        async function deleteProject(projectId, projectTitle) {
            if (!confirm(`Are you sure you want to delete "${projectTitle}"?\n\nThis will permanently delete all episodes, research, interviews, shots, assets, and scripts associated with this project.`)) {
                return;
            }

            try {
                await api(`/api/projects/${projectId}`, 'DELETE');

                // If we deleted the active project, switch to another one
                if (state.selectedProject === projectId) {
                    state.selectedProject = null;
                }

                closeProjectsModal();
                await loadProjectData();

                // Reopen modal to show updated list
                if (state.allProjects.length > 0) {
                    showProjectsModal();
                }
            } catch (error) {
                alert('Error deleting project: ' + error.message);
            }
        }

        async function updateProjectStyle(style) {
            if (!state.selectedProject) return;

            try {
                await api(`/api/projects/${state.selectedProject}`, 'PUT', {
                    style: style
                });
                state.project.style = style;
            } catch (error) {
                alert('Error updating style: ' + error.message);
            }
        }

        // ============== Render Functions ==============

        function renderNav() {
            const nav = document.getElementById('nav');
            const hasProject = state.project !== null;
            nav.innerHTML = navItems.map(item => `
                <button class="nav-item ${state.activeTab === item.id ? 'active' : ''} ${!hasProject ? 'disabled' : ''}"
                        onclick="${hasProject ? `setTab('${item.id}')` : ''}"
                        ${!hasProject ? 'disabled' : ''}>
                    <span>${item.icon}</span>
                    <span>${item.label}</span>
                </button>
            `).join('');
        }

        function setTab(tab) {
            state.activeTab = tab;
            renderNav();
            render();
        }

        function render() {
            const content = document.getElementById('content');

            switch(state.activeTab) {
                case 'dashboard': content.innerHTML = renderDashboard(); break;
                case 'episodes': content.innerHTML = renderEpisodes(); break;
                case 'research': content.innerHTML = renderResearch(); break;
                case 'interviews': content.innerHTML = renderInterviews(); break;
                case 'production': content.innerHTML = renderProduction(); break;
                case 'assets': content.innerHTML = renderAssets(); break;
                case 'scripts': content.innerHTML = renderScripts(); break;
            }
        }

        function renderDashboard() {
            if (!state.project) return '<div class="card">No project loaded</div>';

            const sourceInfo = state.project.blueprintFile?.sourceFile
                ? `<span class="blueprint-source">Generated from: ${state.project.blueprintFile.sourceFile}</span>`
                : '';

            const blueprintSection = state.project.blueprintFile ? `
                <div class="card blueprint-card">
                    <div class="blueprint-header">
                        <h3>Project Blueprint</h3>
                        <div class="blueprint-actions">
                            <button class="btn btn-sm btn-secondary" onclick="toggleBlueprintView()">
                                <span id="blueprint-toggle-text">View Document</span>
                            </button>
                            <a href="/api/download/${state.project.blueprintFile.path}" class="btn btn-sm btn-secondary">Download</a>
                        </div>
                    </div>
                    <div class="blueprint-meta">
                        <span class="blueprint-filename">üìÑ ${state.project.blueprintFile.filename}</span>
                        <span class="blueprint-size">${formatFileSize(state.project.blueprintFile.size)}</span>
                        ${sourceInfo}
                    </div>
                    <div id="blueprint-content" class="blueprint-document-content" style="display: none;">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Loading blueprint...</p>
                        </div>
                    </div>
                </div>
            ` : '';

            return `
                <div class="card">
                    <p class="mb-2">${state.project.description || '<em>No description</em>'}</p>
                    <div class="mt-3">
                        <span class="badge badge-blue">${state.project.status}</span>
                        ${state.project.style ? `<span class="badge badge-gray">${state.project.style}</span>` : ''}
                    </div>
                </div>

                ${blueprintSection}

                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-number" style="color: #2563eb;">${state.episodes.length}</div>
                        <div class="stat-label">Episodes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #059669;">${state.interviews.length}</div>
                        <div class="stat-label">Interviews</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #7c3aed;">${state.shots.length}</div>
                        <div class="stat-label">Shots</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #ea580c;">${state.assets.length}</div>
                        <div class="stat-label">Assets</div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="mb-3">Episodes Overview</h3>
                    <div class="episode-list">
                        ${state.episodes.map(ep => `
                            <div class="episode-item">
                                <div class="flex" style="justify-content: space-between;">
                                    <div>
                                        <h4>${ep.title}</h4>
                                        <p>${ep.description}</p>
                                    </div>
                                    <span class="badge badge-gray">${ep.status}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        let blueprintLoaded = false;
        async function toggleBlueprintView() {
            const content = document.getElementById('blueprint-content');
            const toggleText = document.getElementById('blueprint-toggle-text');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleText.textContent = 'Hide Document';

                // Load content if not already loaded
                if (!blueprintLoaded && state.project.blueprintFile) {
                    const filePath = state.project.blueprintFile.path;
                    const isPdf = filePath.endsWith('.pdf');

                    if (isPdf) {
                        // Embed PDF viewer
                        content.innerHTML = `<iframe src="/api/document/${filePath}" class="blueprint-pdf-viewer"></iframe>`;
                        blueprintLoaded = true;
                    } else {
                        // Render markdown
                        try {
                            const response = await fetch(`/api/document/${filePath}`);
                            const text = await response.text();
                            content.innerHTML = `<div class="blueprint-rendered">${marked.parse(text)}</div>`;
                            blueprintLoaded = true;
                        } catch (error) {
                            content.innerHTML = `<p class="text-muted">Error loading blueprint: ${error.message}</p>`;
                        }
                    }
                }
            } else {
                content.style.display = 'none';
                toggleText.textContent = 'View Document';
            }
        }

        function renderEpisodes() {
            // Count episodes with research
            const episodesWithResearch = state.episodes.filter(ep =>
                state.research.some(r => r.episodeId === ep.id)
            ).length;
            const episodesWithoutResearch = state.episodes.length - episodesWithResearch;

            return `
                <div class="section-header">
                    <h2>Episodes</h2>
                    <div class="flex gap-2">
                        ${state.episodes.length > 0 ? `
                            <button class="ai-button" onclick="showGenerateAllResearchModal()">
                                ‚ú® Generate All Research
                            </button>
                        ` : ''}
                        <button class="btn btn-primary" onclick="showAddModal('episode')">+ Add</button>
                    </div>
                </div>
                ${episodesWithoutResearch > 0 && state.episodes.length > 1 ? `
                    <div class="info-banner mb-3">
                        <span>${episodesWithoutResearch} episode${episodesWithoutResearch > 1 ? 's' : ''} without research</span>
                    </div>
                ` : ''}
                ${state.episodes.map(ep => {
                    const episodeResearch = state.research.filter(r => r.episodeId === ep.id);
                    const hasResearch = episodeResearch.length > 0;
                    return `
                        <div class="card episode-card">
                            <div class="item-header">
                                <div class="flex-1">
                                    <h3>${ep.title}</h3>
                                    <p>${ep.description}</p>
                                    <div class="flex gap-2 mt-2">
                                        <span class="text-sm text-muted">${ep.duration || ''}</span>
                                        <span class="badge badge-gray">${ep.status}</span>
                                        ${hasResearch ? `<span class="badge badge-green">üìö ${episodeResearch.length} research</span>` : ''}
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn-icon" onclick="showEditModal('episode', '${ep.id}')">‚úèÔ∏è</button>
                                    <button class="btn-icon" onclick="deleteItem('episodes', '${ep.id}')">üóëÔ∏è</button>
                                </div>
                            </div>

                            <!-- Episode Research Section -->
                            <div class="episode-research-section">
                                <div class="episode-research-header">
                                    <span class="text-sm font-bold">Research</span>
                                    <button class="ai-button-sm" onclick="generateEpisodeResearch('${ep.id}', '${ep.title.replace(/'/g, "\\'")}', '${(ep.description || '').replace(/'/g, "\\'")}')">
                                        ‚ú® Generate
                                    </button>
                                </div>
                                ${hasResearch ? `
                                    <div class="episode-research-list">
                                        ${episodeResearch.map(r => `
                                            <div class="episode-research-item">
                                                <div class="episode-research-content" onclick="toggleResearchExpand(this)">
                                                    <div class="episode-research-title">${r.title}</div>
                                                    <div class="episode-research-preview">${(r.content || '').substring(0, 150)}...</div>
                                                    <div class="episode-research-full" style="display:none;">${marked.parse(r.content || '')}</div>
                                                </div>
                                                <button class="btn-icon btn-icon-sm" onclick="deleteItem('research', '${r.id}')">üóëÔ∏è</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p class="text-sm text-muted">No research yet. Click Generate to create research for this episode.</p>
                                `}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function toggleResearchExpand(element) {
            const preview = element.querySelector('.episode-research-preview');
            const full = element.querySelector('.episode-research-full');
            if (preview.style.display === 'none') {
                preview.style.display = 'block';
                full.style.display = 'none';
            } else {
                preview.style.display = 'none';
                full.style.display = 'block';
            }
        }

        async function generateEpisodeResearch(episodeId, title, description) {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            content.innerHTML = `
                <div class="ai-section">
                    <h4>üîç Deep Verified Research</h4>
                    <p class="text-sm text-muted mb-3">Researching "${title}" with multi-source verification</p>
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Verifying sources and cross-referencing facts...</p>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            try {
                const response = await api('/api/ai/episode-research', 'POST', {
                    episodeId,
                    episodeTitle: title,
                    episodeDescription: description,
                    projectId: state.selectedProject,
                    projectTitle: state.project?.title || '',
                    projectDescription: state.project?.description || '',
                    projectStyle: state.project?.style || ''
                });

                const sourcesInfo = response.sources && response.sources.length > 0
                    ? `<p class="text-sm text-muted mb-2">üì• ${response.sources.length} source document(s) being downloaded to Assets</p>`
                    : '';

                content.innerHTML = `
                    <div class="ai-section">
                        <h4>‚úÖ Verified Research Generated</h4>
                        <p class="text-sm text-muted mb-2">Research for "${title}" has been saved.</p>
                        ${sourcesInfo}
                        <div class="ai-result">
                            <div class="ai-result-content">${marked.parse(response.result)}</div>
                        </div>
                        <button class="btn btn-primary mt-3" onclick="closeAIModal(); loadProjectData();">Done</button>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `
                    <div class="ai-section">
                        <h4>Error</h4>
                        <p class="text-muted">Failed to generate research: ${error.message}</p>
                        <button class="btn btn-primary mt-3" onclick="closeAIModal()">Close</button>
                    </div>
                `;
            }
        }

        function showGenerateAllResearchModal() {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            const episodesWithResearch = state.episodes.filter(ep =>
                state.research.some(r => r.episodeId === ep.id)
            );
            const episodesWithoutResearch = state.episodes.filter(ep =>
                !state.research.some(r => r.episodeId === ep.id)
            );

            content.innerHTML = `
                <div class="ai-section">
                    <h4>‚ú® Generate Research for All Episodes</h4>
                    <p class="text-sm text-muted mb-3">AI will generate research notes for each selected episode.</p>

                    <div class="generate-all-options mb-3">
                        <label class="checkbox-label">
                            <input type="checkbox" id="skip-with-research" checked>
                            <span>Skip episodes that already have research (${episodesWithResearch.length} episodes)</span>
                        </label>
                    </div>

                    <div class="episode-select-list">
                        <div class="episode-select-header">
                            <span class="text-sm font-bold">Episodes to process:</span>
                            <button class="btn-link text-sm" onclick="toggleAllEpisodeSelection(true)">Select All</button>
                            <button class="btn-link text-sm" onclick="toggleAllEpisodeSelection(false)">Deselect All</button>
                        </div>
                        ${state.episodes.map(ep => {
                            const hasResearch = state.research.some(r => r.episodeId === ep.id);
                            return `
                                <label class="episode-select-item ${hasResearch ? 'has-research' : ''}">
                                    <input type="checkbox" class="episode-checkbox" data-episode-id="${ep.id}"
                                           data-title="${ep.title.replace(/"/g, '&quot;')}"
                                           data-description="${(ep.description || '').replace(/"/g, '&quot;')}"
                                           ${!hasResearch ? 'checked' : ''}>
                                    <div class="episode-select-info">
                                        <span class="episode-select-title">${ep.title}</span>
                                        ${hasResearch ? '<span class="badge badge-green badge-sm">Has Research</span>' : ''}
                                    </div>
                                </label>
                            `;
                        }).join('')}
                    </div>

                    <div class="form-actions mt-3">
                        <button class="btn btn-secondary" onclick="closeAIModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="generateAllEpisodeResearch()">Generate Research</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            // Update checkbox states based on skip option
            document.getElementById('skip-with-research').addEventListener('change', function() {
                const skipChecked = this.checked;
                document.querySelectorAll('.episode-select-item.has-research input').forEach(cb => {
                    cb.checked = !skipChecked;
                });
            });
        }

        function toggleAllEpisodeSelection(selectAll) {
            document.querySelectorAll('.episode-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
        }

        async function generateAllEpisodeResearch() {
            const checkboxes = document.querySelectorAll('.episode-checkbox:checked');
            const episodes = [];

            checkboxes.forEach(cb => {
                episodes.push({
                    id: cb.dataset.episodeId,
                    title: cb.dataset.title,
                    description: cb.dataset.description
                });
            });

            if (episodes.length === 0) {
                alert('Please select at least one episode.');
                return;
            }

            const content = document.getElementById('ai-modal-content');
            let completed = 0;

            content.innerHTML = `
                <div class="ai-section">
                    <h4>üîç Deep Verified Research</h4>
                    <div class="progress-info">
                        <p>Processing <span id="progress-current">0</span> of ${episodes.length} episodes</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <p id="progress-episode" class="text-sm text-muted mt-2"></p>
                    </div>
                </div>
            `;

            const results = [];
            let totalSources = 0;
            for (const ep of episodes) {
                document.getElementById('progress-episode').textContent = `Verifying sources: ${ep.title}`;

                try {
                    const response = await api('/api/ai/episode-research', 'POST', {
                        episodeId: ep.id,
                        episodeTitle: ep.title,
                        episodeDescription: ep.description,
                        projectId: state.selectedProject,
                        projectTitle: state.project?.title || '',
                        projectDescription: state.project?.description || '',
                        projectStyle: state.project?.style || ''
                    });
                    const sourceCount = response.sources ? response.sources.length : 0;
                    totalSources += sourceCount;
                    results.push({ episode: ep.title, success: true, sources: sourceCount });
                } catch (error) {
                    results.push({ episode: ep.title, success: false, error: error.message });
                }

                completed++;
                document.getElementById('progress-current').textContent = completed;
                document.getElementById('progress-fill').style.width = `${(completed / episodes.length) * 100}%`;
            }

            const successful = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;

            content.innerHTML = `
                <div class="ai-section">
                    <h4>‚úÖ Verified Research Complete</h4>
                    <p class="mb-2">${successful} of ${episodes.length} episodes processed successfully.</p>
                    <p class="text-sm text-muted mb-3">üì• ${totalSources} source document(s) downloading to Assets</p>
                    ${failed > 0 ? `
                        <div class="error-list mb-3">
                            <p class="text-sm font-bold">Failed:</p>
                            ${results.filter(r => !r.success).map(r => `
                                <p class="text-sm text-muted">‚Ä¢ ${r.episode}: ${r.error}</p>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="btn btn-primary" onclick="closeAIModal(); loadProjectData();">Done</button>
                </div>
            `;
        }

        function renderResearch() {
            return `
                <div class="section-header">
                    <h2>Research</h2>
                    <div class="flex gap-2">
                        <button class="ai-button" onclick="showAIModal('research')">‚ú® AI Research</button>
                        <button class="btn btn-primary" onclick="showAddModal('research')">+ Add</button>
                    </div>
                </div>
                ${state.research.map(r => `
                    <div class="card">
                        <div class="item-header">
                            <div class="flex-1">
                                <div class="flex gap-2 mb-1 items-center">
                                    <h3>${r.title}</h3>
                                    <span class="badge badge-blue">${r.category}</span>
                                </div>
                                <div class="research-content">${marked.parse(r.content || '')}</div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-icon" onclick="showEditModal('research', '${r.id}')">‚úèÔ∏è</button>
                                <button class="btn-icon" onclick="deleteItem('research', '${r.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderInterviews() {
            return `
                <div class="section-header">
                    <h2>Interviews</h2>
                    <div class="flex gap-2">
                        <button class="ai-button" onclick="showAIModal('interview')">‚ú® AI Questions</button>
                        <button class="btn btn-primary" onclick="showAddModal('interview')">+ Add</button>
                    </div>
                </div>
                ${state.interviews.map(i => `
                    <div class="card">
                        <div class="item-header">
                            <div class="flex-1">
                                <h3>${i.subject}</h3>
                                <p>${i.role}</p>
                                <span class="badge badge-green mt-2">${i.status}</span>
                                ${i.questions ? `
                                    <div class="mt-3">
                                        <div class="text-sm font-bold mb-1">Questions:</div>
                                        <div class="text-sm whitespace-pre">${i.questions}</div>
                                    </div>
                                ` : ''}
                                ${i.notes ? `<div class="mt-2 text-sm text-muted italic">${i.notes}</div>` : ''}
                            </div>
                            <div class="item-actions">
                                <button class="btn-icon" onclick="showEditModal('interview', '${i.id}')">‚úèÔ∏è</button>
                                <button class="btn-icon" onclick="deleteItem('interviews', '${i.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderProduction() {
            return `
                <div class="section-header">
                    <h2>Production</h2>
                    <div class="flex gap-2">
                        <button class="ai-button" onclick="showAIModal('shot-ideas')">‚ú® Shot Ideas</button>
                        <button class="btn btn-primary" onclick="showAddModal('shot')">+ Add</button>
                    </div>
                </div>
                ${state.shots.map(s => {
                    const episode = state.episodes.find(e => e.id === s.episodeId);
                    return `
                        <div class="card">
                            <div class="item-header">
                                <div class="flex-1">
                                    ${episode ? `<div class="text-xs mb-1" style="color: #2563eb;">${episode.title}</div>` : ''}
                                    <p class="font-bold">${s.description}</p>
                                    <div class="text-sm mt-1 text-muted">
                                        <div>üìç ${s.location}</div>
                                        <div>üé• ${s.equipment}</div>
                                        ${s.shootDate ? `<div>üìÖ ${new Date(s.shootDate).toLocaleDateString()}</div>` : ''}
                                    </div>
                                    <span class="badge badge-purple mt-2">${s.status}</span>
                                </div>
                                <div class="item-actions">
                                    <button class="btn-icon" onclick="showEditModal('shot', '${s.id}')">‚úèÔ∏è</button>
                                    <button class="btn-icon" onclick="deleteItem('shots', '${s.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderAssets() {
            // Separate source documents from regular assets
            const sourceAssets = state.assets.filter(a => a.isSourceDocument);
            const regularAssets = state.assets.filter(a => !a.isSourceDocument);

            return `
                <div class="section-header">
                    <h2>Assets</h2>
                    <button class="btn btn-primary" onclick="showAddModal('asset')">+ Add</button>
                </div>

                ${sourceAssets.length > 0 ? `
                    <div class="card">
                        <div class="source-docs-header">
                            <div>
                                <h3 class="mb-1">üìÑ Source Documents (${sourceAssets.length})</h3>
                                <p class="text-sm text-muted">Auto-archived from AI research for verification</p>
                            </div>
                            <div class="source-docs-bulk-actions">
                                <a href="/api/projects/${state.selectedProject}/assets/download-all" class="btn btn-secondary btn-sm" title="Download all as ZIP">‚¨áÔ∏è Download All</a>
                                <button class="btn btn-danger btn-sm" onclick="clearAllSourceDocuments()" title="Delete all source documents">üóëÔ∏è Clear All</button>
                            </div>
                        </div>
                        <div class="source-assets-grid">
                            ${sourceAssets.map(a => `
                                <div class="source-asset-card">
                                    <div class="source-asset-info">
                                        <div class="source-asset-title">${a.title}</div>
                                        <div class="source-asset-meta">
                                            <span>${formatBytes(a.sizeBytes)}</span>
                                            <span class="badge badge-green">${a.status}</span>
                                        </div>
                                        <a href="${a.source}" target="_blank" class="source-asset-url">${truncateUrl(a.source)}</a>
                                    </div>
                                    <div class="source-asset-actions">
                                        ${a.gcsPath ? `
                                            <button class="btn-icon" onclick="viewSourceDocument('${a.gcsPath}')" title="View">üëÅÔ∏è</button>
                                            <a href="/api/download/${a.gcsPath}" class="btn-icon" title="Download">‚¨áÔ∏è</a>
                                        ` : ''}
                                        <button class="btn-icon" onclick="deleteItem('assets', '${a.id}')" title="Delete">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                ${regularAssets.map(a => `
                    <div class="card">
                        <div class="item-header">
                            <div class="flex-1">
                                <div class="flex gap-2 mb-1 items-center">
                                    <h3>${a.title}</h3>
                                    <span class="badge badge-gray">${a.type}</span>
                                </div>
                                <p class="text-sm">Source: ${a.source}</p>
                                <span class="badge badge-orange mt-2">${a.status}</span>
                                ${a.notes ? `<p class="text-sm mt-2">${a.notes}</p>` : ''}
                            </div>
                            <div class="item-actions">
                                <button class="btn-icon" onclick="showEditModal('asset', '${a.id}')">‚úèÔ∏è</button>
                                <button class="btn-icon" onclick="deleteItem('assets', '${a.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderScripts() {
            return `
                <div class="section-header">
                    <h2>Scripts</h2>
                    <div class="flex gap-2">
                        <button class="ai-button" onclick="showAIModal('script')">‚ú® AI Outline</button>
                        <button class="btn btn-primary" onclick="showAddModal('script')">+ Add</button>
                    </div>
                </div>
                ${state.scripts.map(s => {
                    const episode = state.episodes.find(e => e.id === s.episodeId);
                    return `
                        <div class="card">
                            <div class="item-header">
                                <div class="flex-1">
                                    ${episode ? `<div class="text-xs mb-1" style="color: #2563eb;">${episode.title}</div>` : ''}
                                    <h3>${s.title}</h3>
                                    <div class="script-content">${s.content}</div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn-icon" onclick="showEditModal('script', '${s.id}')">‚úèÔ∏è</button>
                                    <button class="btn-icon" onclick="deleteItem('scripts', '${s.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // ============== Modal Functions ==============

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showAddModal(type) {
            const forms = {
                episode: `
                    <form onsubmit="saveItem(event, 'episodes')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <input type="text" name="title" placeholder="Episode title" required>
                        <textarea name="description" placeholder="Description" rows="3"></textarea>
                        <input type="text" name="duration" placeholder="Duration (e.g., 45 min)">
                        <select name="status">
                            <option value="Planning">Planning</option>
                            <option value="Research">Research</option>
                            <option value="Scripting">Scripting</option>
                            <option value="Production">Production</option>
                            <option value="Post-Production">Post-Production</option>
                            <option value="Complete">Complete</option>
                        </select>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `,
                research: `
                    <form onsubmit="saveItem(event, 'research')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <input type="text" name="title" placeholder="Title" required>
                        <textarea name="content" placeholder="Research notes" rows="5" required></textarea>
                        <select name="category">
                            <option value="General">General</option>
                            <option value="Archive">Archive</option>
                            <option value="Background">Background</option>
                            <option value="Contact">Contact</option>
                            <option value="Location">Location</option>
                        </select>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `,
                interview: `
                    <form onsubmit="saveItem(event, 'interviews')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <input type="text" name="subject" placeholder="Subject name" required>
                        <input type="text" name="role" placeholder="Role/Title">
                        <select name="status">
                            <option value="Potential">Potential</option>
                            <option value="Requested">Requested</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <textarea name="questions" placeholder="Interview questions" rows="4"></textarea>
                        <textarea name="notes" placeholder="Notes" rows="2"></textarea>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `,
                shot: `
                    <form onsubmit="saveItem(event, 'shots')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <textarea name="description" placeholder="Shot description" rows="3" required></textarea>
                        <input type="text" name="location" placeholder="Location">
                        <input type="text" name="equipment" placeholder="Equipment needed">
                        <input type="date" name="shootDate">
                        <select name="status">
                            <option value="Pending">Pending</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Shot">Shot</option>
                            <option value="Edited">Edited</option>
                        </select>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `,
                asset: `
                    <form onsubmit="saveItem(event, 'assets')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <input type="text" name="title" placeholder="Asset title" required>
                        <select name="type">
                            <option value="Video">Video</option>
                            <option value="Audio">Audio</option>
                            <option value="Image">Image</option>
                            <option value="Document">Document</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="text" name="source" placeholder="Source">
                        <select name="status">
                            <option value="Needed">Needed</option>
                            <option value="Licensing">Licensing</option>
                            <option value="Acquired">Acquired</option>
                            <option value="Processed">Processed</option>
                        </select>
                        <textarea name="notes" placeholder="Notes" rows="2"></textarea>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `,
                script: `
                    <form onsubmit="saveItem(event, 'scripts')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <input type="text" name="title" placeholder="Script title" required>
                        <textarea name="content" placeholder="Script content" rows="10" required></textarea>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `
            };

            const titles = {
                episode: 'Add Episode',
                research: 'Add Research',
                interview: 'Add Interview',
                shot: 'Add Shot',
                asset: 'Add Asset',
                script: 'Add Script'
            };

            showModal(titles[type], forms[type]);
        }

        function showEditModal(type, id) {
            const collectionMap = {
                episode: 'episodes',
                research: 'research',
                interview: 'interviews',
                shot: 'shots',
                asset: 'assets',
                script: 'scripts'
            };

            const item = state[collectionMap[type]].find(i => i.id === id);
            if (!item) return;

            // Simplified - show add modal with prefilled data
            showAddModal(type);

            // Fill in form data after a short delay
            setTimeout(() => {
                const form = document.querySelector('#modal-body form');
                if (form) {
                    form.dataset.editId = id;
                    form.dataset.editType = collectionMap[type];

                    Object.keys(item).forEach(key => {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) input.value = item[key] || '';
                    });
                }
            }, 50);
        }

        async function saveItem(event, collection) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const editId = form.dataset.editId;
                const editType = form.dataset.editType;

                if (editId && editType) {
                    // Update existing
                    await api(`/api/${editType}/${editId}`, 'PUT', data);
                } else {
                    // Create new
                    await api(`/api/${collection}`, 'POST', data);
                }

                closeModal();
                await loadProjectData();
            } catch (error) {
                alert('Error saving: ' + error.message);
            }
        }

        async function deleteItem(collection, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            try {
                await api(`/api/${collection}/${id}`, 'DELETE');
                await loadProjectData();
            } catch (error) {
                alert('Error deleting: ' + error.message);
            }
        }

        // ============== AI Modal Functions ==============

        function showAIModal(type, context = {}) {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            const templates = {
                research: `
                    <div class="ai-section">
                        <h4>üîç Research Assistant</h4>
                        <p class="text-sm text-muted mb-3">Get help finding sources, contacts, and background information.</p>
                        <div class="input-with-mic">
                            <textarea id="ai-query" class="ai-input" rows="3" placeholder="What do you need research help with?"></textarea>
                            <button type="button" class="mic-btn" data-for="ai-query" onclick="toggleSpeech('ai-query')" title="Speak">üé§</button>
                        </div>
                        <button class="ai-button" onclick="runAI('research')" id="ai-btn">‚ú® Get Research Help</button>
                        <div id="ai-result"></div>
                    </div>
                `,
                interview: `
                    <div class="ai-section">
                        <h4>üí¨ Interview Question Generator</h4>
                        <p class="text-sm text-muted mb-3">Generate thoughtful interview questions.</p>
                        <div class="input-with-mic">
                            <input id="ai-subject" class="ai-input" placeholder="Subject name">
                            <button type="button" class="mic-btn" data-for="ai-subject" onclick="toggleSpeech('ai-subject')" title="Speak">üé§</button>
                        </div>
                        <div class="input-with-mic">
                            <input id="ai-role" class="ai-input" placeholder="Their role">
                            <button type="button" class="mic-btn" data-for="ai-role" onclick="toggleSpeech('ai-role')" title="Speak">üé§</button>
                        </div>
                        <div class="input-with-mic">
                            <textarea id="ai-context" class="ai-input" rows="2" placeholder="What aspects to explore?"></textarea>
                            <button type="button" class="mic-btn" data-for="ai-context" onclick="toggleSpeech('ai-context')" title="Speak">üé§</button>
                        </div>
                        <button class="ai-button" onclick="runAI('interview')" id="ai-btn">‚ú® Generate Questions</button>
                        <div id="ai-result"></div>
                    </div>
                `,
                script: `
                    <div class="ai-section">
                        <h4>üìù Script Outline Generator</h4>
                        <p class="text-sm text-muted mb-3">Create a structured outline for your episode.</p>
                        <div class="input-with-mic">
                            <input id="ai-title" class="ai-input" placeholder="Episode title" value="${context.title || ''}">
                            <button type="button" class="mic-btn" data-for="ai-title" onclick="toggleSpeech('ai-title')" title="Speak">üé§</button>
                        </div>
                        <div class="input-with-mic">
                            <textarea id="ai-topic" class="ai-input" rows="3" placeholder="What should this episode cover?"></textarea>
                            <button type="button" class="mic-btn" data-for="ai-topic" onclick="toggleSpeech('ai-topic')" title="Speak">üé§</button>
                        </div>
                        <input id="ai-duration" class="ai-input" placeholder="Target duration (e.g., 45 minutes)">
                        <button class="ai-button" onclick="runAI('script')" id="ai-btn">‚ú® Generate Outline</button>
                        <div id="ai-result"></div>
                    </div>
                `,
                'shot-ideas': `
                    <div class="ai-section">
                        <h4>üé¨ Shot List Ideas</h4>
                        <p class="text-sm text-muted mb-3">Get creative shot ideas for your documentary.</p>
                        <div class="input-with-mic">
                            <textarea id="ai-scene" class="ai-input" rows="3" placeholder="Describe the scene or topic"></textarea>
                            <button type="button" class="mic-btn" data-for="ai-scene" onclick="toggleSpeech('ai-scene')" title="Speak">üé§</button>
                        </div>
                        <button class="ai-button" onclick="runAI('shot-ideas')" id="ai-btn">‚ú® Get Shot Ideas</button>
                        <div id="ai-result"></div>
                    </div>
                `,
                'expand-topic': `
                    <div class="ai-section">
                        <h4>üí° Topic Expansion</h4>
                        <p class="text-sm text-muted mb-3">Explore angles, themes, and storylines.</p>
                        <div class="input-with-mic">
                            <textarea id="ai-topic" class="ai-input" rows="3" placeholder="What topic to explore?">${context.topic || ''}</textarea>
                            <button type="button" class="mic-btn" data-for="ai-topic" onclick="toggleSpeech('ai-topic')" title="Speak">üé§</button>
                        </div>
                        <label class="checkbox-label">
                            <input type="checkbox" id="ai-use-project-context" ${context.topic ? 'checked' : ''}>
                            <span>Include project context (${state.project?.title || 'current project'})</span>
                        </label>
                        <button class="ai-button" onclick="runAI('expand-topic')" id="ai-btn">‚ú® Expand Topic</button>
                        <div id="ai-result"></div>
                    </div>
                `
            };

            content.innerHTML = templates[type] || '';
            content.dataset.aiType = type;
            modal.classList.add('active');
        }

        function closeAIModal() {
            document.getElementById('ai-modal').classList.remove('active');
        }

        async function runAI(type) {
            const btn = document.getElementById('ai-btn');
            const resultDiv = document.getElementById('ai-result');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-small"></span> Processing...';
            resultDiv.innerHTML = '';

            try {
                let endpoint, body;
                const projectTitle = state.project?.title || '';

                switch(type) {
                    case 'research':
                        endpoint = '/api/ai/research';
                        body = {
                            query: document.getElementById('ai-query').value,
                            projectContext: `${projectTitle} - ${state.project?.description || ''}`,
                            projectId: state.selectedProject,
                            downloadSources: true
                        };
                        break;
                    case 'interview':
                        endpoint = '/api/ai/interview-questions';
                        body = {
                            subject: document.getElementById('ai-subject').value,
                            role: document.getElementById('ai-role').value,
                            context: document.getElementById('ai-context').value,
                            projectTitle
                        };
                        break;
                    case 'script':
                        endpoint = '/api/ai/script-outline';
                        body = {
                            title: document.getElementById('ai-title').value,
                            topic: document.getElementById('ai-topic').value,
                            duration: document.getElementById('ai-duration').value || '45 minutes',
                            projectTitle
                        };
                        break;
                    case 'shot-ideas':
                        endpoint = '/api/ai/shot-ideas';
                        body = {
                            scene: document.getElementById('ai-scene').value,
                            projectTitle
                        };
                        break;
                    case 'expand-topic':
                        endpoint = '/api/ai/expand-topic';
                        const useProjectContext = document.getElementById('ai-use-project-context')?.checked;
                        body = {
                            topic: document.getElementById('ai-topic').value,
                            projectTitle: useProjectContext ? projectTitle : ''
                        };
                        break;
                }

                const response = await api(endpoint, 'POST', body);

                // Build source documents section for research
                let sourcesHtml = '';
                if (type === 'research' && response.sources && response.sources.length > 0) {
                    sourcesHtml = `
                        <div class="source-docs-section">
                            <h4>üìÑ Archived Source Documents (${response.sources.length})</h4>
                            <div class="source-docs-list">
                                ${response.sources.map(src => `
                                    <div class="source-doc-item">
                                        <div class="source-doc-info">
                                            <span class="source-doc-title">${src.title || 'Document'}</span>
                                            <a href="${src.url}" target="_blank" class="source-doc-url">${truncateUrl(src.url)}</a>
                                        </div>
                                        <div class="source-doc-actions">
                                            ${src.gcsPath ? `
                                                <button class="btn-icon" onclick="viewSourceDocument('${src.gcsPath}')" title="View">üëÅÔ∏è</button>
                                                <a href="/api/download/${src.gcsPath}" class="btn-icon" title="Download">‚¨áÔ∏è</a>
                                            ` : `<span class="badge badge-gray">${src.status}</span>`}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <p class="text-sm text-muted mt-2">Sources added to Assets tab for verification.</p>
                        </div>
                    `;
                }

                resultDiv.innerHTML = `
                    <div class="ai-result">
                        <div class="ai-result-content">${marked.parse(response.result)}</div>
                        <div class="ai-result-raw" style="display:none;">${response.result}</div>
                        ${sourcesHtml}
                        ${type === 'research' ? `
                            <button class="btn btn-primary mt-3" onclick="saveAIAsResearch()">üíæ Save as Research Note</button>
                        ` : ''}
                        ${type === 'interview' ? `
                            <button class="btn btn-primary mt-3" onclick="saveAIAsInterview()">üíæ Save as Interview</button>
                        ` : ''}
                        ${type === 'script' ? `
                            <button class="btn btn-primary mt-3" onclick="saveAIAsScript()">üíæ Save as Script</button>
                        ` : ''}
                        ${type === 'expand-topic' ? `
                            <button class="btn btn-primary mt-3" onclick="saveAIAsResearchFromTopic()">üíæ Save as Research Note</button>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error-card">Error: ${error.message}</div>`;
            }

            btn.disabled = false;
            btn.innerHTML = '‚ú® Try Again';
        }

        async function saveAIAsResearch() {
            const query = document.getElementById('ai-query').value;
            const result = document.querySelector('#ai-result .ai-result-raw').textContent;

            await api('/api/research', 'POST', {
                projectId: state.selectedProject,
                title: query.substring(0, 100),
                content: result,
                category: 'AI Generated'
            });

            closeAIModal();
            state.activeTab = 'research';
            await loadProjectData();
        }

        async function saveAIAsInterview() {
            const subject = document.getElementById('ai-subject').value;
            const role = document.getElementById('ai-role').value;
            const result = document.querySelector('#ai-result .ai-result-raw').textContent;

            await api('/api/interviews', 'POST', {
                projectId: state.selectedProject,
                subject,
                role,
                status: 'Potential',
                questions: result,
                notes: 'Generated by AI'
            });

            closeAIModal();
            state.activeTab = 'interviews';
            await loadProjectData();
        }

        async function saveAIAsScript() {
            const title = document.getElementById('ai-title').value;
            const result = document.querySelector('#ai-result .ai-result-raw').textContent;

            await api('/api/scripts', 'POST', {
                projectId: state.selectedProject,
                title,
                content: result
            });

            closeAIModal();
            state.activeTab = 'scripts';
            await loadProjectData();
        }

        async function saveAIAsResearchFromTopic() {
            const topic = document.getElementById('ai-topic').value;
            const result = document.querySelector('#ai-result .ai-result-raw').textContent;

            await api('/api/research', 'POST', {
                projectId: state.selectedProject,
                title: `Topic Exploration: ${topic.substring(0, 80)}`,
                content: result,
                category: 'AI Generated'
            });

            closeAIModal();
            state.activeTab = 'research';
            await loadProjectData();
        }

        // ============== Speech Recognition ==============

        let recognition = null;
        let isListening = false;

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    const targetInput = document.querySelector('[data-speech-target]');
                    if (targetInput) {
                        targetInput.value = transcript;
                    }
                };

                recognition.onend = () => {
                    isListening = false;
                    updateMicButtons();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    updateMicButtons();
                    if (event.error === 'not-allowed') {
                        alert('Microphone access denied. Please allow microphone access to use speech input.');
                    }
                };

                return true;
            }
            return false;
        }

        function toggleSpeech(inputId) {
            if (!recognition && !initSpeechRecognition()) {
                alert('Speech recognition is not supported in your browser. Try Chrome or Edge.');
                return;
            }

            // Remove previous target
            document.querySelectorAll('[data-speech-target]').forEach(el => el.removeAttribute('data-speech-target'));

            const input = document.getElementById(inputId);
            if (!input) return;

            if (isListening) {
                recognition.stop();
                isListening = false;
            } else {
                input.setAttribute('data-speech-target', 'true');
                recognition.start();
                isListening = true;
            }
            updateMicButtons();
        }

        function updateMicButtons() {
            document.querySelectorAll('.mic-btn').forEach(btn => {
                if (isListening && btn.dataset.for === document.querySelector('[data-speech-target]')?.id) {
                    btn.classList.add('listening');
                    btn.innerHTML = 'üî¥';
                } else {
                    btn.classList.remove('listening');
                    btn.innerHTML = 'üé§';
                }
            });
        }

        // ============== Source Document Functions ==============

        function truncateUrl(url) {
            if (!url) return '';
            try {
                const urlObj = new URL(url);
                const path = urlObj.pathname.length > 20 ? urlObj.pathname.substring(0, 20) + '...' : urlObj.pathname;
                return urlObj.hostname + path;
            } catch {
                return url.length > 40 ? url.substring(0, 40) + '...' : url;
            }
        }

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function viewSourceDocument(path) {
            window.open(`/api/document/${path}`, '_blank');
        }

        async function clearAllSourceDocuments() {
            const sourceCount = state.assets.filter(a => a.isSourceDocument).length;
            if (!confirm(`Are you sure you want to delete all ${sourceCount} source documents?\n\nThis will permanently remove all archived research sources for this project.`)) {
                return;
            }

            try {
                const result = await api(`/api/projects/${state.selectedProject}/assets/clear-sources`, 'DELETE');
                await loadProjectData();
                alert(`Deleted ${result.deleted} source document(s).`);
            } catch (error) {
                alert('Error clearing source documents: ' + error.message);
            }
        }

        // ============== Theme Toggle ==============

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        }

        function updateThemeButton(theme) {
            const btn = document.getElementById('theme-btn');
            if (btn) {
                btn.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                btn.title = theme === 'light' ? 'Switch to dark mode' : 'Switch to light mode';
            }
        }

        // ============== Initialize ==============

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            renderNav();
            loadProjectData();
        });
    </script>
</body>
</html>
