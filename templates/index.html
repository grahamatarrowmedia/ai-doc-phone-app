<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Documentary Production App</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        // Configure marked for better rendering
        marked.setOptions({
            breaks: true,
            gfm: true
        });
        // Custom renderer to open links in new tab
        // marked.js v4+ uses token objects instead of separate parameters
        const renderer = new marked.Renderer();
        renderer.link = function(token) {
            // Handle both old API (separate params) and new API (token object)
            let href, title, text;
            if (typeof token === 'object' && token !== null && 'href' in token) {
                // New API: token is an object with href, title, text properties
                href = token.href || '';
                title = token.title || '';
                text = token.text || href;
            } else {
                // Old API: token is href, arguments[1] is title, arguments[2] is text
                href = token || '';
                title = arguments[1] || '';
                text = arguments[2] || href;
            }
            const titleAttr = title ? ` title="${title}"` : '';
            return `<a href="${href}"${titleAttr} target="_blank" rel="noopener noreferrer">${text}</a>`;
        };
        marked.use({ renderer });
    </script>
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
    <div id="app">
        {% if app_env == 'dev' or app_env == 'development' %}
        <div class="dev-banner">
            ‚ö†Ô∏è DEVELOPMENT VERSION - v{{ app_version }}
        </div>
        {% elif app_env == 'research' %}
        <div class="dev-banner" style="background: linear-gradient(90deg, #7c3aed 0%, #6d28d9 100%);">
            üî¨ RESEARCH BUILD - v{{ app_version }}
        </div>
        {% endif %}
        <div class="container">
            <!-- Header -->
            <header class="header">
                <div class="header-top">
                    <h1>üìΩÔ∏è Documentary Production</h1>
                    <div class="header-actions">
                        <span class="version-badge" title="App version">v{{ app_version }}</span>
                        <button class="header-btn" onclick="toggleTheme()" id="theme-btn" title="Toggle dark/light mode">üåô</button>
                        <button class="header-btn" onclick="showProjectsModal()">üìÅ Projects</button>
                    </div>
                </div>
                <p id="project-name" class="project-name-clickable" onclick="showProjectsModal()">Loading...</p>
            </header>

            <!-- Main Content -->
            <main class="content" id="content">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading project data...</p>
                </div>
            </main>

            <!-- Bottom Navigation -->
            <nav class="nav" id="nav"></nav>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Modal</h3>
                <button onclick="closeModal()" class="close-btn">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ú® AI Assistant</h3>
                <button onclick="closeAIModal()" class="close-btn">&times;</button>
            </div>
            <div id="ai-modal-content"></div>
        </div>
    </div>

    <!-- Feedback Button -->
    <button id="feedback-btn" class="feedback-floating-btn" onclick="openFeedback()" title="Send Feedback">
        üí¨
    </button>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="modal">
        <div class="modal-content feedback-modal-content">
            <div class="modal-header">
                <h3>üìù Send Feedback</h3>
                <button onclick="closeFeedbackModal()" class="close-btn">&times;</button>
            </div>
            <div id="feedback-body">
                <div class="feedback-screenshot-container">
                    <p class="text-muted mb-2">Screenshot captured:</p>
                    <div id="feedback-screenshot-preview" class="feedback-screenshot"></div>
                </div>

                <div class="feedback-input-section">
                    <label for="feedback-text">Your feedback:</label>
                    <div class="feedback-textarea-container">
                        <textarea id="feedback-text" placeholder="Describe your feedback, suggestion, or issue..." rows="4"></textarea>
                        <button id="voice-btn" class="voice-input-btn" onclick="toggleVoiceInput()" title="Voice input">
                            üé§
                        </button>
                    </div>
                    <div id="voice-status" class="voice-status"></div>
                </div>

                <div class="feedback-type-section">
                    <label>Feedback type:</label>
                    <div class="feedback-type-options">
                        <label class="feedback-type-option">
                            <input type="radio" name="feedback-type" value="bug" checked>
                            <span>üêõ Bug</span>
                        </label>
                        <label class="feedback-type-option">
                            <input type="radio" name="feedback-type" value="feature">
                            <span>üí° Feature</span>
                        </label>
                        <label class="feedback-type-option">
                            <input type="radio" name="feedback-type" value="general">
                            <span>üí¨ General</span>
                        </label>
                    </div>
                </div>

                <div class="feedback-actions">
                    <button class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitFeedback()" id="submit-feedback-btn">
                        Send Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Projects Modal -->
    <div id="projects-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÅ Projects</h3>
                <button onclick="closeProjectsModal()" class="close-btn">&times;</button>
            </div>
            <div id="projects-modal-content"></div>
        </div>
    </div>

    <script>
        // App State
        const state = {
            activeTab: 'dashboard',
            allProjects: [],
            selectedProject: null,
            project: null,
            episodes: [],
            research: [],
            interviews: [],
            shots: [],
            assets: [],
            scripts: [],
            loading: false
        };

        // Navigation items
        const navItems = [
            { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
            { id: 'episodes', icon: 'üìù', label: 'Episodes' },
            { id: 'research', icon: 'üîç', label: 'Research' },
            { id: 'interviews', icon: 'üë•', label: 'Interviews' },
            { id: 'production', icon: 'üé¨', label: 'Production' },
            { id: 'assets', icon: 'üì¶', label: 'Assets' },
            { id: 'scripts', icon: 'üìÑ', label: 'Scripts' }
        ];

        // ============== API Functions ==============

        async function api(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data) options.body = JSON.stringify(data);

            const response = await fetch(endpoint, options);
            return response.json();
        }

        async function loadProjectData() {
            try {
                // Get projects
                let projects = await api('/api/projects');

                state.allProjects = projects || [];

                // If no projects, show empty state
                if (!projects || projects.length === 0) {
                    state.selectedProject = null;
                    state.project = null;
                    state.episodes = [];
                    state.research = [];
                    state.interviews = [];
                    state.shots = [];
                    state.assets = [];
                    state.scripts = [];
                    document.getElementById('project-name').textContent = 'No projects';
                    renderEmptyState();
                    renderNav();
                    return;
                }

                // Use previously selected project or default to first
                if (!state.selectedProject || !projects.find(p => p.id === state.selectedProject)) {
                    state.selectedProject = projects[0].id;
                }
                state.project = projects.find(p => p.id === state.selectedProject);
                document.getElementById('project-name').textContent = state.project.title + ' ‚ñº';

                // Load all related data
                const [episodes, research, interviews, shots, assets, scripts] = await Promise.all([
                    api(`/api/projects/${state.selectedProject}/episodes`),
                    api(`/api/projects/${state.selectedProject}/research`),
                    api(`/api/projects/${state.selectedProject}/interviews`),
                    api(`/api/projects/${state.selectedProject}/shots`),
                    api(`/api/projects/${state.selectedProject}/assets`),
                    api(`/api/projects/${state.selectedProject}/scripts`)
                ]);

                state.episodes = episodes || [];
                state.research = research || [];
                state.interviews = interviews || [];
                state.shots = shots || [];
                state.assets = assets || [];
                state.scripts = scripts || [];

                renderNav();
                render();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card error-card">
                        <h3>Error Loading Data</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadProjectData()">Retry</button>
                    </div>
                `;
            }
        }

        function renderEmptyState() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìΩÔ∏è</div>
                    <h2>Welcome to Documentary Production</h2>
                    <p>Get started by creating your first documentary project.</p>
                    <button class="btn btn-primary btn-lg" onclick="showNewProjectModal()">
                        + Create New Project
                    </button>
                </div>
            `;
        }

        function showNewProjectModal() {
            const modal = document.getElementById('projects-modal');
            const content = document.getElementById('projects-modal-content');

            content.innerHTML = `
                <div id="new-project-form">
                    <p class="text-muted mb-3">Create your first documentary project to get started.</p>

                    <div class="project-create-tabs">
                        <button type="button" class="tab-btn active" onclick="switchProjectTab('manual')">Manual Entry</button>
                        <button type="button" class="tab-btn" onclick="switchProjectTab('blueprint')">From Blueprint</button>
                    </div>

                    <div id="manual-entry-tab" class="project-tab-content active">
                        <form onsubmit="createNewProject(event)">
                            <div class="input-with-mic">
                                <input type="text" id="new-project-title" placeholder="Project title" required>
                                <button type="button" class="mic-btn" data-for="new-project-title" onclick="toggleSpeech('new-project-title')" title="Speak">üé§</button>
                            </div>
                            <div class="input-with-mic">
                                <textarea id="new-project-description" placeholder="Brief description of your documentary" rows="3"></textarea>
                                <button type="button" class="mic-btn" data-for="new-project-description" onclick="toggleSpeech('new-project-description')" title="Speak">üé§</button>
                            </div>
                            <div class="input-with-mic">
                                <textarea id="new-project-style" placeholder="Documentary style (e.g., investigative journalism, personal narrative, observational, educational, cinematic)" rows="2"></textarea>
                                <button type="button" class="mic-btn" data-for="new-project-style" onclick="toggleSpeech('new-project-style')" title="Speak">üé§</button>
                            </div>
                            <select id="new-project-status">
                                <option value="Planning">Planning</option>
                                <option value="Research">Research</option>
                                <option value="In Production">In Production</option>
                                <option value="Post-Production">Post-Production</option>
                            </select>
                            <div class="episode-count-field">
                                <label for="new-project-episodes">Number of episodes to generate:</label>
                                <input type="number" id="new-project-episodes" min="1" max="20" value="5">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeProjectsModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Create Project</button>
                            </div>
                        </form>
                    </div>

                    <div id="blueprint-tab" class="project-tab-content">
                        <form onsubmit="createProjectFromBlueprint(event)">
                            <div class="blueprint-upload-area" onclick="document.getElementById('blueprint-file').click()">
                                <div class="upload-icon">üìÑ</div>
                                <p class="upload-text">Click to upload a blueprint</p>
                                <p class="upload-hint">Document (PDF, TXT) or Video (MP4, MOV)</p>
                                <input type="file" id="blueprint-file" accept=".pdf,.txt,.doc,.docx,.mp4,.mov,.avi,.mkv,.webm" onchange="handleBlueprintSelect(this)" style="display:none">
                            </div>
                            <div id="blueprint-file-info" class="blueprint-file-info" style="display:none">
                                <span id="blueprint-filename"></span>
                                <button type="button" class="btn-icon" onclick="clearBlueprintFile()">‚úï</button>
                            </div>
                            <div class="episode-count-field">
                                <label for="blueprint-episodes">Number of episodes to generate:</label>
                                <input type="number" id="blueprint-episodes" min="1" max="20" value="5">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeProjectsModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary" id="blueprint-submit-btn" disabled>Analyze & Create</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function switchProjectTab(tab) {
            document.querySelectorAll('.project-create-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.project-tab-content').forEach(content => content.classList.remove('active'));

            if (tab === 'manual') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('manual-entry-tab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('blueprint-tab').classList.add('active');
            }
        }

        function handleBlueprintSelect(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('blueprint-file-info').style.display = 'flex';
                document.getElementById('blueprint-filename').textContent = file.name;
                document.getElementById('blueprint-submit-btn').disabled = false;
                document.querySelector('.blueprint-upload-area').style.display = 'none';
            }
        }

        function clearBlueprintFile() {
            document.getElementById('blueprint-file').value = '';
            document.getElementById('blueprint-file-info').style.display = 'none';
            document.getElementById('blueprint-submit-btn').disabled = true;
            document.querySelector('.blueprint-upload-area').style.display = 'block';
        }

        async function createProjectFromBlueprint(event) {
            event.preventDefault();

            const fileInput = document.getElementById('blueprint-file');
            const file = fileInput.files[0];
            if (!file) return;

            const numEpisodes = parseInt(document.getElementById('blueprint-episodes').value) || 5;
            const submitBtn = document.getElementById('blueprint-submit-btn');

            submitBtn.disabled = true;

            try {
                let data;
                const LARGE_FILE_THRESHOLD = 30 * 1024 * 1024; // 30MB

                if (file.size > LARGE_FILE_THRESHOLD) {
                    // Large file: upload in chunks to GCS, then analyze
                    const CHUNK_SIZE = 25 * 1024 * 1024; // 25MB chunks
                    const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

                    submitBtn.innerHTML = '<span class="spinner-small"></span> Preparing upload...';

                    // Step 1: Initialize chunked upload
                    const initResponse = await fetch('/api/upload/init', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: file.name,
                            contentType: file.type || 'video/mp4',
                            fileSize: file.size,
                            totalChunks: totalChunks
                        })
                    });
                    const initData = await initResponse.json();

                    if (initData.error) {
                        throw new Error(initData.error);
                    }

                    // Step 2: Upload chunks
                    for (let i = 0; i < totalChunks; i++) {
                        const start = i * CHUNK_SIZE;
                        const end = Math.min(start + CHUNK_SIZE, file.size);
                        const chunk = file.slice(start, end);
                        const progress = Math.round((i + 1) / totalChunks * 100);

                        submitBtn.innerHTML = `<span class="spinner-small"></span> Uploading ${progress}%...`;

                        const formData = new FormData();
                        formData.append('chunk', chunk);
                        formData.append('chunkIndex', i);
                        formData.append('totalChunks', totalChunks);
                        formData.append('blobPath', initData.blobPath);
                        formData.append('contentType', file.type || 'video/mp4');

                        const chunkResponse = await fetch(`/api/upload/chunk/${initData.uploadId}`, {
                            method: 'POST',
                            body: formData
                        });
                        const chunkData = await chunkResponse.json();

                        if (chunkData.error) {
                            throw new Error(chunkData.error);
                        }
                    }

                    // Step 3: Analyze from GCS
                    submitBtn.innerHTML = '<span class="spinner-small"></span> Analyzing video...';

                    const analyzeResponse = await fetch('/api/ai/analyze-blueprint', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            gcsUri: initData.gcsUri,
                            filename: file.name,
                            numEpisodes: numEpisodes
                        })
                    });
                    data = await analyzeResponse.json();

                } else {
                    // Small file: direct upload
                    submitBtn.innerHTML = '<span class="spinner-small"></span> Analyzing...';

                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('numEpisodes', numEpisodes);

                    const response = await fetch('/api/ai/analyze-blueprint', {
                        method: 'POST',
                        body: formData
                    });
                    data = await response.json();
                }

                if (data.error) {
                    throw new Error(data.error);
                }

                const blueprint = data.blueprint;

                // Create the project with extracted data (including blueprint file if present)
                const projectData = {
                    title: blueprint.title,
                    description: blueprint.description,
                    style: blueprint.style,
                    status: 'Planning'
                };

                if (blueprint.blueprintFile) {
                    projectData.blueprintFile = blueprint.blueprintFile;
                }
                if (blueprint.blueprintContent) {
                    projectData.blueprintContent = blueprint.blueprintContent;
                }

                const newProject = await api('/api/projects', 'POST', projectData);

                state.selectedProject = newProject.id;
                closeProjectsModal();
                await loadProjectData();

                // Show the extracted episodes for confirmation
                showBlueprintEpisodes(newProject.id, blueprint);

            } catch (error) {
                alert('Error analyzing blueprint: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Analyze & Create';
            }
        }

        function showBlueprintEpisodes(projectId, blueprint) {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            content.innerHTML = `
                <div class="ai-section">
                    <h4>üìã Blueprint Analysis Complete</h4>
                    <p class="text-sm text-muted mb-3">Project created: <strong>${blueprint.title}</strong></p>
                    <p class="text-sm mb-3"><em>Style: ${blueprint.style}</em></p>

                    <h5 class="mb-2">Suggested Episodes:</h5>
                    <div class="topic-list">
                        ${blueprint.episodes.map((ep, i) => `
                            <label class="topic-item">
                                <input type="checkbox" checked data-topic-index="${i}"
                                       data-title="${ep.title?.replace(/"/g, '&quot;') || ''}"
                                       data-description="${ep.description?.replace(/"/g, '&quot;') || ''}"
                                       data-order="${ep.order || i + 1}">
                                <div>
                                    <strong>${ep.title}</strong>
                                    <p class="text-sm text-muted">${ep.description}</p>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    <div class="form-actions mt-3">
                        <button class="btn btn-secondary" onclick="closeAIModal()">Skip Episodes</button>
                        <button class="btn btn-primary" onclick="createBlueprintEpisodes('${projectId}')">Create Selected</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        async function createBlueprintEpisodes(projectId) {
            const checkboxes = document.querySelectorAll('.topic-list input[type="checkbox"]:checked');
            const episodes = Array.from(checkboxes).map(cb => ({
                title: cb.dataset.title,
                description: cb.dataset.description,
                order: parseInt(cb.dataset.order),
                status: 'Planning',
                projectId: projectId
            }));

            if (episodes.length === 0) {
                closeAIModal();
                return;
            }

            const content = document.getElementById('ai-modal-content');
            content.innerHTML = `
                <div class="ai-section">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Creating ${episodes.length} episodes...</p>
                    </div>
                </div>
            `;

            try {
                for (const episode of episodes) {
                    await api('/api/episodes', 'POST', episode);
                }
                await loadProjectData();
                closeAIModal();
            } catch (error) {
                alert('Error creating episodes: ' + error.message);
                closeAIModal();
            }
        }

        // ============== Project Management ==============

        function showProjectsModal() {
            const modal = document.getElementById('projects-modal');
            const content = document.getElementById('projects-modal-content');

            content.innerHTML = `
                <div class="projects-list">
                    ${state.allProjects.map(p => `
                        <div class="project-item ${p.id === state.selectedProject ? 'active' : ''}">
                            <div class="project-item-info" onclick="switchProject('${p.id}')">
                                <h4>${p.title}</h4>
                                <p>${p.description || 'No description'}</p>
                                <span class="badge badge-blue">${p.status || 'Active'}</span>
                            </div>
                            <div class="project-item-actions">
                                ${p.id === state.selectedProject ? '<span class="project-active-badge">‚úì Active</span>' : ''}
                                <button class="btn-icon delete-project-btn" onclick="deleteProject('${p.id}', '${p.title.replace(/'/g, "\\'")}')" title="Delete project">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="projects-actions">
                    <button class="btn btn-primary" onclick="showNewProjectForm()">+ New Project</button>
                </div>
                <div id="new-project-form" style="display: none;">
                    <h4 class="mt-3 mb-2">Create New Project</h4>

                    <div class="project-create-tabs">
                        <button type="button" class="tab-btn active" onclick="switchProjectTab('manual')">Manual Entry</button>
                        <button type="button" class="tab-btn" onclick="switchProjectTab('blueprint')">From Blueprint</button>
                    </div>

                    <div id="manual-entry-tab" class="project-tab-content active">
                        <form onsubmit="createNewProject(event)">
                            <div class="input-with-mic">
                                <input type="text" id="new-project-title" placeholder="Project title" required>
                                <button type="button" class="mic-btn" data-for="new-project-title" onclick="toggleSpeech('new-project-title')" title="Speak">üé§</button>
                            </div>
                            <div class="input-with-mic">
                                <textarea id="new-project-description" placeholder="Brief description of your documentary" rows="3"></textarea>
                                <button type="button" class="mic-btn" data-for="new-project-description" onclick="toggleSpeech('new-project-description')" title="Speak">üé§</button>
                            </div>
                            <div class="input-with-mic">
                                <textarea id="new-project-style" placeholder="Documentary style (e.g., investigative journalism, personal narrative, observational, educational, cinematic)" rows="2"></textarea>
                                <button type="button" class="mic-btn" data-for="new-project-style" onclick="toggleSpeech('new-project-style')" title="Speak">üé§</button>
                            </div>
                            <select id="new-project-status">
                                <option value="Planning">Planning</option>
                                <option value="Research">Research</option>
                                <option value="In Production">In Production</option>
                                <option value="Post-Production">Post-Production</option>
                            </select>
                            <div class="episode-count-field">
                                <label for="new-project-episodes">Number of episodes to generate:</label>
                                <input type="number" id="new-project-episodes" min="1" max="20" value="5">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="hideNewProjectForm()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Create Project</button>
                            </div>
                        </form>
                    </div>

                    <div id="blueprint-tab" class="project-tab-content">
                        <form onsubmit="createProjectFromBlueprint(event)">
                            <div class="blueprint-upload-area" onclick="document.getElementById('blueprint-file').click()">
                                <div class="upload-icon">üìÑ</div>
                                <p class="upload-text">Click to upload a blueprint</p>
                                <p class="upload-hint">Document (PDF, TXT) or Video (MP4, MOV)</p>
                                <input type="file" id="blueprint-file" accept=".pdf,.txt,.doc,.docx,.mp4,.mov,.avi,.mkv,.webm" onchange="handleBlueprintSelect(this)" style="display:none">
                            </div>
                            <div id="blueprint-file-info" class="blueprint-file-info" style="display:none">
                                <span id="blueprint-filename"></span>
                                <button type="button" class="btn-icon" onclick="clearBlueprintFile()">‚úï</button>
                            </div>
                            <div class="episode-count-field">
                                <label for="blueprint-episodes">Number of episodes to generate:</label>
                                <input type="number" id="blueprint-episodes" min="1" max="20" value="5">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="hideNewProjectForm()">Cancel</button>
                                <button type="submit" class="btn btn-primary" id="blueprint-submit-btn" disabled>Analyze & Create</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeProjectsModal() {
            document.getElementById('projects-modal').classList.remove('active');
        }

        function showNewProjectForm() {
            document.getElementById('new-project-form').style.display = 'block';
        }

        function hideNewProjectForm() {
            document.getElementById('new-project-form').style.display = 'none';
        }

        async function switchProject(projectId) {
            state.selectedProject = projectId;
            closeProjectsModal();
            await loadProjectData();
        }

        async function createNewProject(event) {
            event.preventDefault();

            const title = document.getElementById('new-project-title').value;
            const description = document.getElementById('new-project-description').value;
            const style = document.getElementById('new-project-style').value;
            const status = document.getElementById('new-project-status').value;
            const numEpisodes = parseInt(document.getElementById('new-project-episodes').value) || 5;

            try {
                const newProject = await api('/api/projects', 'POST', {
                    title,
                    description,
                    style,
                    status
                });

                state.selectedProject = newProject.id;
                closeProjectsModal();
                await loadProjectData();

                // Generate episode topics for the new project
                showTopicSuggestions(newProject.id, title, description, style, numEpisodes);
            } catch (error) {
                alert('Error creating project: ' + error.message);
            }
        }

        async function showTopicSuggestions(projectId, title, description, style = '', numEpisodes = 5) {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            content.innerHTML = `
                <div class="ai-section">
                    <h4>‚ú® Generating ${numEpisodes} Episode Ideas...</h4>
                    <p class="text-sm text-muted mb-3">Based on your project${style ? ' and style' : ''}, we're suggesting episode topics.</p>
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Analyzing "${title}"...</p>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            try {
                const response = await api('/api/ai/generate-topics', 'POST', {
                    title,
                    description,
                    style,
                    numTopics: numEpisodes
                });

                if (response.topics && response.topics.length > 0) {
                    content.innerHTML = `
                        <div class="ai-section">
                            <h4>üìù Suggested Episodes</h4>
                            <p class="text-sm text-muted mb-3">Select which episodes to create for your documentary.</p>
                            <div class="topic-list">
                                ${response.topics.map((topic, i) => `
                                    <label class="topic-item">
                                        <input type="checkbox" checked data-topic-index="${i}"
                                               data-title="${topic.title?.replace(/"/g, '&quot;') || ''}"
                                               data-description="${topic.description?.replace(/"/g, '&quot;') || ''}">
                                        <div class="topic-content">
                                            <div class="topic-title">${topic.title || 'Episode ' + (i+1)}</div>
                                            <div class="topic-description">${topic.description || ''}</div>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                            <div class="form-actions mt-3">
                                <button class="btn btn-secondary" onclick="closeAIModal()">Skip</button>
                                <button class="btn btn-primary" onclick="createSelectedEpisodes('${projectId}')">Create Selected Episodes</button>
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="ai-section">
                            <h4>üìù Episode Ideas</h4>
                            <p class="text-muted">Could not generate suggestions. You can add episodes manually.</p>
                            ${response.error ? `<p class="text-sm text-muted">Error: ${response.error}</p>` : ''}
                            <button class="btn btn-primary mt-3" onclick="closeAIModal()">Continue</button>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="ai-section">
                        <h4>üìù Episode Ideas</h4>
                        <p class="text-muted">Could not generate suggestions: ${error.message}</p>
                        <button class="btn btn-primary mt-3" onclick="closeAIModal()">Continue</button>
                    </div>
                `;
            }
        }

        async function createSelectedEpisodes(projectId) {
            const checkboxes = document.querySelectorAll('.topic-list input[type="checkbox"]:checked');
            const episodes = [];

            checkboxes.forEach((cb, index) => {
                episodes.push({
                    projectId: projectId,
                    title: cb.dataset.title,
                    description: cb.dataset.description,
                    status: 'Planning',
                    duration: '45 min'
                });
            });

            if (episodes.length === 0) {
                closeAIModal();
                return;
            }

            // Show loading
            const content = document.getElementById('ai-modal-content');
            content.innerHTML = `
                <div class="ai-section">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Creating ${episodes.length} episode(s)...</p>
                    </div>
                </div>
            `;

            try {
                // Create episodes sequentially
                for (const episode of episodes) {
                    await api('/api/episodes', 'POST', episode);
                }

                closeAIModal();
                state.activeTab = 'episodes';
                await loadProjectData();
            } catch (error) {
                alert('Error creating episodes: ' + error.message);
                closeAIModal();
            }
        }

        async function deleteProject(projectId, projectTitle) {
            if (!confirm(`Are you sure you want to delete "${projectTitle}"?\n\nThis will permanently delete all episodes, research, interviews, shots, assets, and scripts associated with this project.`)) {
                return;
            }

            try {
                await api(`/api/projects/${projectId}`, 'DELETE');

                // If we deleted the active project, switch to another one
                if (state.selectedProject === projectId) {
                    state.selectedProject = null;
                }

                closeProjectsModal();
                await loadProjectData();

                // Reopen modal to show updated list
                if (state.allProjects.length > 0) {
                    showProjectsModal();
                }
            } catch (error) {
                alert('Error deleting project: ' + error.message);
            }
        }

        async function updateProjectStyle(style) {
            if (!state.selectedProject) return;

            try {
                await api(`/api/projects/${state.selectedProject}`, 'PUT', {
                    style: style
                });
                state.project.style = style;
            } catch (error) {
                alert('Error updating style: ' + error.message);
            }
        }

        // ============== Render Functions ==============

        function renderNav() {
            const nav = document.getElementById('nav');
            const hasProject = state.project !== null;
            nav.innerHTML = navItems.map(item => `
                <button class="nav-item ${state.activeTab === item.id ? 'active' : ''} ${!hasProject ? 'disabled' : ''}"
                        onclick="${hasProject ? `setTab('${item.id}')` : ''}"
                        ${!hasProject ? 'disabled' : ''}>
                    <span>${item.icon}</span>
                    <span>${item.label}</span>
                </button>
            `).join('');
        }

        function setTab(tab) {
            state.activeTab = tab;
            renderNav();
            render();
        }

        function render() {
            const content = document.getElementById('content');

            switch(state.activeTab) {
                case 'dashboard':
                    content.innerHTML = renderDashboard();
                    // Load blueprint content after rendering
                    setTimeout(() => loadBlueprintContent(), 100);
                    break;
                case 'episodes': content.innerHTML = renderEpisodes(); break;
                case 'research': content.innerHTML = renderResearch(); break;
                case 'interviews': content.innerHTML = renderInterviews(); break;
                case 'production': content.innerHTML = renderProduction(); break;
                case 'assets': content.innerHTML = renderAssets(); break;
                case 'scripts': content.innerHTML = renderScripts(); break;
            }
        }

        function renderDashboard() {
            if (!state.project) return '<div class="card">No project loaded</div>';

            const sourceInfo = state.project.blueprintFile?.sourceFile
                ? `<span class="blueprint-source">Generated from: ${state.project.blueprintFile.sourceFile}</span>`
                : '';

            const blueprintSection = state.project.blueprintFile ? `
                <div class="card blueprint-card">
                    <div class="blueprint-header">
                        <h3>Project Blueprint</h3>
                        <div class="blueprint-actions">
                            <a href="/api/download/${state.project.blueprintFile.path}" class="btn btn-sm btn-primary" download>
                                Download PDF
                            </a>
                        </div>
                    </div>
                    <div class="blueprint-meta">
                        ${sourceInfo}
                    </div>
                    <div id="blueprint-content" class="blueprint-document-content">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Loading blueprint...</p>
                        </div>
                    </div>
                </div>
            ` : '';

            return `
                <div class="card">
                    <p class="mb-2">${state.project.description || '<em>No description</em>'}</p>
                    <div class="mt-3">
                        <span class="badge badge-blue">${state.project.status}</span>
                        ${state.project.style ? `<span class="badge badge-gray">${state.project.style}</span>` : ''}
                    </div>
                </div>

                ${blueprintSection}

                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-number" style="color: #2563eb;">${state.episodes.length}</div>
                        <div class="stat-label">Episodes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #059669;">${state.interviews.length}</div>
                        <div class="stat-label">Interviews</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #7c3aed;">${state.shots.length}</div>
                        <div class="stat-label">Shots</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #ea580c;">${state.assets.length}</div>
                        <div class="stat-label">Assets</div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="mb-3">Episodes Overview</h3>
                    <div class="episode-list">
                        ${state.episodes.map(ep => `
                            <div class="episode-item">
                                <div class="flex" style="justify-content: space-between;">
                                    <div>
                                        <h4>${ep.title}</h4>
                                        <p>${ep.description}</p>
                                    </div>
                                    <span class="badge badge-gray">${ep.status}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        let blueprintLoaded = false;
        async function loadBlueprintContent() {
            const content = document.getElementById('blueprint-content');
            if (!content || blueprintLoaded || !state.project?.blueprintFile) return;

            try {
                // First check if blueprintContent is already in the project data
                if (state.project.blueprintContent) {
                    content.innerHTML = `<div class="blueprint-rendered">${marked.parse(state.project.blueprintContent)}</div>`;
                    blueprintLoaded = true;
                    return;
                }

                // Try to get the markdown content via API
                const response = await fetch(`/api/projects/${state.project.id}/blueprint-content`);

                if (response.ok) {
                    const data = await response.json();
                    if (data.content && data.content.length > 50) {
                        content.innerHTML = `<div class="blueprint-rendered">${marked.parse(data.content)}</div>`;
                        blueprintLoaded = true;
                        return;
                    }
                }

                // Show fallback message if no content available
                content.innerHTML = `<p class="text-muted">Blueprint document available for download</p>`;
                blueprintLoaded = true;

            } catch (error) {
                content.innerHTML = `<p class="text-muted">Blueprint document available for download</p>`;
                blueprintLoaded = true;
            }
        }

        function renderEpisodes() {
            // Count episodes with research
            const episodesWithResearch = state.episodes.filter(ep =>
                state.research.some(r => r.episodeId === ep.id)
            ).length;
            const episodesWithoutResearch = state.episodes.length - episodesWithResearch;

            return `
                <div class="section-header">
                    <h2>Episodes</h2>
                    <div class="flex gap-2">
                        <button class="btn btn-primary" onclick="showAddModal('episode')">+ Add</button>
                    </div>
                </div>
                ${episodesWithoutResearch > 0 && state.episodes.length > 1 ? `
                    <div class="info-banner mb-3">
                        <span>${episodesWithoutResearch} episode${episodesWithoutResearch > 1 ? 's' : ''} without research</span>
                    </div>
                ` : ''}
                ${state.episodes.map(ep => {
                    const episodeResearch = state.research.filter(r => r.episodeId === ep.id);
                    const hasResearch = episodeResearch.length > 0;
                    return `
                        <div class="card episode-card">
                            <div class="item-header">
                                <div class="flex-1">
                                    <h3>${ep.title}</h3>
                                    <p>${ep.description}</p>
                                    <div class="flex gap-2 mt-2">
                                        <span class="text-sm text-muted">${ep.duration || ''}</span>
                                        <span class="badge badge-gray">${ep.status}</span>
                                        ${hasResearch ? `<span class="badge badge-green">üìö ${episodeResearch.length} research</span>` : ''}
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn-icon" onclick="showEditModal('episode', '${ep.id}')">‚úèÔ∏è</button>
                                    <button class="btn-icon" onclick="deleteItem('episodes', '${ep.id}')">üóëÔ∏è</button>
                                </div>
                            </div>

                            <!-- Episode Research Section -->
                            <div class="episode-research-section">
                                <div class="episode-research-header">
                                    <span class="text-sm font-bold">Research</span>
                                    <div class="flex gap-2">
                                        ${ep.research ? `
                                            <button class="btn-sm btn-secondary" onclick="viewSavedResearch('${ep.id}', '${ep.title.replace(/'/g, "\\'")}')">
                                                üìñ View Saved
                                            </button>
                                        ` : ''}
                                        <button class="ai-button-sm" onclick="doSimpleResearch('${ep.id}', '${ep.title.replace(/'/g, "\\'")}', '${(ep.description || '').replace(/'/g, "\\'")}')">
                                            üîç ${ep.research ? 'Regenerate' : 'Research'}
                                        </button>
                                    </div>
                                </div>
                                ${ep.research ? `
                                    <div class="saved-research-indicator" onclick="viewSavedResearch('${ep.id}', '${ep.title.replace(/'/g, "\\'")}')">
                                        <span class="badge badge-green">‚úì Research saved</span>
                                        <span class="text-xs text-muted">${ep.researchGeneratedAt ? 'Generated: ' + new Date(ep.researchGeneratedAt).toLocaleDateString() : ''}</span>
                                    </div>
                                ` : `
                                    <p class="text-sm text-muted">No research saved. Click Research to generate.</p>
                                `}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function toggleResearchExpand(element) {
            const preview = element.querySelector('.episode-research-preview');
            const full = element.querySelector('.episode-research-full');
            if (preview.style.display === 'none') {
                preview.style.display = 'block';
                full.style.display = 'none';
            } else {
                preview.style.display = 'none';
                full.style.display = 'block';
            }
        }

        async function doSimpleResearch(episodeId, title, description) {
            console.log('=== doSimpleResearch START ===');
            console.log('episodeId:', episodeId);
            console.log('title:', title);
            console.log('description:', description);
            console.log('state.currentProject:', state.currentProject);

            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            content.innerHTML = `
                <div class="ai-section">
                    <h4>üîç Researching: ${title}</h4>
                    <p class="text-sm text-muted mb-3">Gathering background research with source links...</p>
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>This may take a moment...</p>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            try {
                console.log('Calling /api/ai/simple-research...');
                const response = await api('/api/ai/simple-research', 'POST', {
                    title: title,
                    description: description,
                    episodeId: episodeId,
                    projectId: state.currentProject,
                    save: false
                });

                console.log('=== RESEARCH API RESPONSE ===');
                console.log('Full response:', response);
                console.log('response.result type:', typeof response.result);
                console.log('response.saved:', response.saved);
                console.log('response.episodeId:', response.episodeId);

                // Get the result text
                let resultText = response.result;

                if (!resultText || typeof resultText !== 'string') {
                    console.error('Invalid result:', resultText);
                    throw new Error('Invalid response format');
                }

                console.log('Result text length:', resultText.length);
                console.log('First 500 chars:', resultText.substring(0, 500));

                // Use marked.parse() to convert markdown to HTML
                const htmlContent = marked.parse(resultText);

                console.log('Parsed HTML length:', htmlContent.length);
                console.log('First 500 chars of HTML:', htmlContent.substring(0, 500));

                content.innerHTML = `
                    <div class="ai-section">
                        <h4>üîç Research: ${title}</h4>
                        <p class="text-muted text-sm mb-2">Click Save to store this research with the episode</p>
                        <div class="ai-result research-result-content">
                            ${htmlContent}
                        </div>
                        <div class="ai-actions mt-4">
                            <button class="btn btn-secondary" onclick="closeAIModal()">Close</button>
                            <button class="btn btn-primary" onclick="saveResearch()">üíæ Save</button>
                        </div>
                    </div>
                `;
                // Store result and episodeId for saving
                window.lastResearchResult = resultText;
                window.lastResearchEpisodeId = episodeId;

            } catch (error) {
                console.error('Research error:', error);
                content.innerHTML = `
                    <div class="ai-section">
                        <h4>‚ùå Research Error</h4>
                        <p class="text-error">Failed to generate research: ${error.message}</p>
                        <button class="btn btn-secondary mt-3" onclick="closeAIModal()">Close</button>
                    </div>
                `;
            }
        }

        async function viewSavedResearch(episodeId, title) {
            console.log('=== viewSavedResearch START ===');
            console.log('episodeId:', episodeId);
            console.log('title:', title);

            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            content.innerHTML = `
                <div class="ai-section">
                    <h4>üìñ Loading Research: ${title}</h4>
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Loading saved research...</p>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            try {
                console.log('Fetching saved research from /api/episodes/' + episodeId + '/research');
                const response = await api('/api/episodes/' + episodeId + '/research', 'GET');

                console.log('=== SAVED RESEARCH RESPONSE ===');
                console.log('Full response:', response);
                console.log('response.research type:', typeof response.research);
                console.log('response.research length:', response.research ? response.research.length : 0);
                console.log('response.generatedAt:', response.generatedAt);

                const researchText = response.research;

                if (!researchText) {
                    content.innerHTML = `
                        <div class="ai-section">
                            <h4>üìñ Research: ${title}</h4>
                            <p class="text-muted">No research saved for this episode yet.</p>
                            <div class="ai-actions mt-4">
                                <button class="btn btn-secondary" onclick="closeAIModal()">Close</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                console.log('First 500 chars of research:', researchText.substring(0, 500));

                // Use marked.parse() to convert markdown to HTML with clickable links
                const htmlContent = marked.parse(researchText);

                console.log('Parsed HTML length:', htmlContent.length);
                console.log('First 500 chars of HTML:', htmlContent.substring(0, 500));

                // Check that links are in the HTML
                const linkCount = (htmlContent.match(/<a href=/g) || []).length;
                console.log('Number of links in HTML:', linkCount);

                content.innerHTML = `
                    <div class="ai-section">
                        <h4>üìñ Research: ${title}</h4>
                        <p class="text-xs text-muted mb-2">Generated: ${response.generatedAt ? new Date(response.generatedAt).toLocaleString() : 'Unknown'}</p>
                        <div class="ai-result research-result-content">
                            ${htmlContent}
                        </div>
                        <div class="ai-actions mt-4">
                            <button class="btn btn-secondary" onclick="closeAIModal()">Close</button>
                            <button class="btn btn-primary" onclick="copyResearchToClipboard()">üìã Copy</button>
                            <button class="btn btn-danger" onclick="deleteSavedResearch('${episodeId}', '${title.replace(/'/g, "\\'")}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
                // Store result for copying
                window.lastResearchResult = researchText;

            } catch (error) {
                console.error('Error loading research:', error);
                content.innerHTML = `
                    <div class="ai-section">
                        <h4>‚ùå Error</h4>
                        <p class="text-error">Failed to load research: ${error.message}</p>
                        <button class="btn btn-secondary mt-3" onclick="closeAIModal()">Close</button>
                    </div>
                `;
            }
        }

        async function deleteSavedResearch(episodeId, title) {
            console.log('=== deleteSavedResearch ===');
            console.log('episodeId:', episodeId);

            if (!confirm('Delete saved research for "' + title + '"?')) {
                return;
            }

            try {
                await api('/api/episodes/' + episodeId + '/research', 'DELETE');
                console.log('Research deleted successfully');
                closeAIModal();
                await loadProjectData(state.currentProject);
                render();
            } catch (error) {
                console.error('Error deleting research:', error);
                alert('Failed to delete research: ' + error.message);
            }
        }

        function copyResearchToClipboard() {
            console.log('=== copyResearchToClipboard ===');
            console.log('lastResearchResult length:', window.lastResearchResult ? window.lastResearchResult.length : 0);

            if (window.lastResearchResult) {
                navigator.clipboard.writeText(window.lastResearchResult).then(() => {
                    console.log('Research copied to clipboard');
                    alert('Research copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            }
        }

        async function saveResearch() {
            console.log('=== saveResearch ===');
            console.log('lastResearchEpisodeId:', window.lastResearchEpisodeId);
            console.log('lastResearchResult length:', window.lastResearchResult ? window.lastResearchResult.length : 0);

            if (!window.lastResearchEpisodeId || !window.lastResearchResult) {
                alert('No research to save');
                return;
            }

            try {
                const response = await api('/api/episodes/' + window.lastResearchEpisodeId + '/research', 'PUT', {
                    research: window.lastResearchResult
                });

                console.log('Save response:', response);
                alert('Research saved successfully!');

                // Reload project data to show saved research indicator
                await loadProjectData(state.currentProject);
                render();

            } catch (error) {
                console.error('Error saving research:', error);
                alert('Failed to save research: ' + error.message);
            }
        }

        async function generateEpisodeResearch(episodeId, title, description) {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            content.innerHTML = `
                <div class="ai-section">
                    <h4>üîç Deep Verified Research</h4>
                    <p class="text-sm text-muted mb-3">Researching "${title}" with multi-source verification</p>
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Verifying sources and cross-referencing facts...</p>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            try {
                const response = await api('/api/ai/episode-research', 'POST', {
                    episodeId,
                    episodeTitle: title,
                    episodeDescription: description,
                    projectId: state.selectedProject,
                    projectTitle: state.project?.title || '',
                    projectDescription: state.project?.description || '',
                    projectStyle: state.project?.style || ''
                });

                const sourcesInfo = response.sources && response.sources.length > 0
                    ? `<p class="text-sm text-muted mb-2">üì• ${response.sources.length} source document(s) being downloaded to Assets</p>`
                    : '';

                content.innerHTML = `
                    <div class="ai-section">
                        <h4>‚úÖ Verified Research Generated</h4>
                        <p class="text-sm text-muted mb-2">Research for "${title}" has been saved.</p>
                        ${sourcesInfo}
                        <div class="ai-result">
                            <div class="ai-result-content">${marked.parse(response.result)}</div>
                        </div>
                        <button class="btn btn-primary mt-3" onclick="closeAIModal(); loadProjectData();">Done</button>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `
                    <div class="ai-section">
                        <h4>Error</h4>
                        <p class="text-muted">Failed to generate research: ${error.message}</p>
                        <button class="btn btn-primary mt-3" onclick="closeAIModal()">Close</button>
                    </div>
                `;
            }
        }

        function showGenerateAllResearchModal() {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            const episodesWithResearch = state.episodes.filter(ep =>
                state.research.some(r => r.episodeId === ep.id)
            );
            const episodesWithoutResearch = state.episodes.filter(ep =>
                !state.research.some(r => r.episodeId === ep.id)
            );

            content.innerHTML = `
                <div class="ai-section">
                    <h4>‚ú® Generate Research for All Episodes</h4>
                    <p class="text-sm text-muted mb-3">AI will generate research notes for each selected episode.</p>

                    <div class="generate-all-options mb-3">
                        <label class="checkbox-label">
                            <input type="checkbox" id="skip-with-research" checked>
                            <span>Skip episodes that already have research (${episodesWithResearch.length} episodes)</span>
                        </label>
                    </div>

                    <div class="episode-select-list">
                        <div class="episode-select-header">
                            <span class="text-sm font-bold">Episodes to process:</span>
                            <button class="btn-link text-sm" onclick="toggleAllEpisodeSelection(true)">Select All</button>
                            <button class="btn-link text-sm" onclick="toggleAllEpisodeSelection(false)">Deselect All</button>
                        </div>
                        ${state.episodes.map(ep => {
                            const hasResearch = state.research.some(r => r.episodeId === ep.id);
                            return `
                                <label class="episode-select-item ${hasResearch ? 'has-research' : ''}">
                                    <input type="checkbox" class="episode-checkbox" data-episode-id="${ep.id}"
                                           data-title="${ep.title.replace(/"/g, '&quot;')}"
                                           data-description="${(ep.description || '').replace(/"/g, '&quot;')}"
                                           ${!hasResearch ? 'checked' : ''}>
                                    <div class="episode-select-info">
                                        <span class="episode-select-title">${ep.title}</span>
                                        ${hasResearch ? '<span class="badge badge-green badge-sm">Has Research</span>' : ''}
                                    </div>
                                </label>
                            `;
                        }).join('')}
                    </div>

                    <div class="form-actions mt-3">
                        <button class="btn btn-secondary" onclick="closeAIModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="generateAllEpisodeResearch()">Generate Research</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');

            // Update checkbox states based on skip option
            document.getElementById('skip-with-research').addEventListener('change', function() {
                const skipChecked = this.checked;
                document.querySelectorAll('.episode-select-item.has-research input').forEach(cb => {
                    cb.checked = !skipChecked;
                });
            });
        }

        function toggleAllEpisodeSelection(selectAll) {
            document.querySelectorAll('.episode-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
        }

        async function generateAllEpisodeResearch() {
            const checkboxes = document.querySelectorAll('.episode-checkbox:checked');
            const episodes = [];

            checkboxes.forEach(cb => {
                episodes.push({
                    id: cb.dataset.episodeId,
                    title: cb.dataset.title,
                    description: cb.dataset.description
                });
            });

            if (episodes.length === 0) {
                alert('Please select at least one episode.');
                return;
            }

            const content = document.getElementById('ai-modal-content');
            let completed = 0;

            content.innerHTML = `
                <div class="ai-section">
                    <h4>üîç Deep Verified Research</h4>
                    <div class="progress-info">
                        <p>Processing <span id="progress-current">0</span> of ${episodes.length} episodes</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <p id="progress-episode" class="text-sm text-muted mt-2"></p>
                    </div>
                </div>
            `;

            const results = [];
            let totalSources = 0;
            for (const ep of episodes) {
                document.getElementById('progress-episode').textContent = `Verifying sources: ${ep.title}`;

                try {
                    const response = await api('/api/ai/episode-research', 'POST', {
                        episodeId: ep.id,
                        episodeTitle: ep.title,
                        episodeDescription: ep.description,
                        projectId: state.selectedProject,
                        projectTitle: state.project?.title || '',
                        projectDescription: state.project?.description || '',
                        projectStyle: state.project?.style || ''
                    });
                    const sourceCount = response.sources ? response.sources.length : 0;
                    totalSources += sourceCount;
                    results.push({ episode: ep.title, success: true, sources: sourceCount });
                } catch (error) {
                    results.push({ episode: ep.title, success: false, error: error.message });
                }

                completed++;
                document.getElementById('progress-current').textContent = completed;
                document.getElementById('progress-fill').style.width = `${(completed / episodes.length) * 100}%`;
            }

            const successful = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;

            content.innerHTML = `
                <div class="ai-section">
                    <h4>‚úÖ Verified Research Complete</h4>
                    <p class="mb-2">${successful} of ${episodes.length} episodes processed successfully.</p>
                    <p class="text-sm text-muted mb-3">üì• ${totalSources} source document(s) downloading to Assets</p>
                    ${failed > 0 ? `
                        <div class="error-list mb-3">
                            <p class="text-sm font-bold">Failed:</p>
                            ${results.filter(r => !r.success).map(r => `
                                <p class="text-sm text-muted">‚Ä¢ ${r.episode}: ${r.error}</p>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="btn btn-primary" onclick="closeAIModal(); loadProjectData();">Done</button>
                </div>
            `;
        }

        function renderResearch() {
            return `
                <div class="section-header">
                    <h2>Research</h2>
                </div>
                <div class="card">
                    <div class="placeholder-message">
                        <div class="placeholder-icon">üî¨</div>
                        <h3>AI Research Coming Soon</h3>
                        <p>The AI-powered research functionality is currently under development.</p>
                        <p class="text-muted">This feature will provide verified, multi-source research with automatic source document downloads.</p>
                    </div>
                </div>
            `;
        }

        function renderInterviews() {
            return `
                <div class="section-header">
                    <h2>Interviews</h2>
                    <div class="flex gap-2">
                        <button class="ai-button" onclick="showAIModal('interview')">‚ú® AI Questions</button>
                        <button class="btn btn-primary" onclick="showAddModal('interview')">+ Add</button>
                    </div>
                </div>
                ${state.interviews.map(i => `
                    <div class="card">
                        <div class="item-header">
                            <div class="flex-1">
                                <h3>${i.subject}</h3>
                                <p>${i.role}</p>
                                <span class="badge badge-green mt-2">${i.status}</span>
                                ${i.questions ? `
                                    <div class="mt-3">
                                        <div class="text-sm font-bold mb-1">Questions:</div>
                                        <div class="text-sm whitespace-pre">${i.questions}</div>
                                    </div>
                                ` : ''}
                                ${i.notes ? `<div class="mt-2 text-sm text-muted italic">${i.notes}</div>` : ''}
                            </div>
                            <div class="item-actions">
                                <button class="btn-icon" onclick="showEditModal('interview', '${i.id}')">‚úèÔ∏è</button>
                                <button class="btn-icon" onclick="deleteItem('interviews', '${i.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderProduction() {
            return `
                <div class="section-header">
                    <h2>Production</h2>
                    <div class="flex gap-2">
                        <button class="ai-button" onclick="showAIModal('shot-ideas')">‚ú® Shot Ideas</button>
                        <button class="btn btn-primary" onclick="showAddModal('shot')">+ Add</button>
                    </div>
                </div>
                ${state.shots.map(s => {
                    const episode = state.episodes.find(e => e.id === s.episodeId);
                    return `
                        <div class="card">
                            <div class="item-header">
                                <div class="flex-1">
                                    ${episode ? `<div class="text-xs mb-1" style="color: #2563eb;">${episode.title}</div>` : ''}
                                    <p class="font-bold">${s.description}</p>
                                    <div class="text-sm mt-1 text-muted">
                                        <div>üìç ${s.location}</div>
                                        <div>üé• ${s.equipment}</div>
                                        ${s.shootDate ? `<div>üìÖ ${new Date(s.shootDate).toLocaleDateString()}</div>` : ''}
                                    </div>
                                    <span class="badge badge-purple mt-2">${s.status}</span>
                                </div>
                                <div class="item-actions">
                                    <button class="btn-icon" onclick="showEditModal('shot', '${s.id}')">‚úèÔ∏è</button>
                                    <button class="btn-icon" onclick="deleteItem('shots', '${s.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderAssets() {
            // Separate source documents from regular assets
            const sourceAssets = state.assets.filter(a => a.isSourceDocument);
            const regularAssets = state.assets.filter(a => !a.isSourceDocument);

            return `
                <div class="section-header">
                    <h2>Assets</h2>
                    <button class="btn btn-primary" onclick="showAddModal('asset')">+ Add</button>
                </div>

                ${sourceAssets.length > 0 ? `
                    <div class="card">
                        <div class="source-docs-header">
                            <div>
                                <h3 class="mb-1">üìÑ Source Documents (${sourceAssets.length})</h3>
                                <p class="text-sm text-muted">Auto-archived from AI research for verification</p>
                            </div>
                            <div class="source-docs-bulk-actions">
                                <a href="/api/projects/${state.selectedProject}/assets/download-all" class="btn btn-secondary btn-sm" title="Download all as ZIP">‚¨áÔ∏è Download All</a>
                                <button class="btn btn-danger btn-sm" onclick="clearAllSourceDocuments()" title="Delete all source documents">üóëÔ∏è Clear All</button>
                            </div>
                        </div>
                        <div class="source-assets-grid">
                            ${sourceAssets.map(a => `
                                <div class="source-asset-card">
                                    <div class="source-asset-info">
                                        <div class="source-asset-title">${a.title}</div>
                                        <div class="source-asset-meta">
                                            <span>${formatBytes(a.sizeBytes)}</span>
                                            <span class="badge badge-green">${a.status}</span>
                                        </div>
                                        <a href="${a.source}" target="_blank" class="source-asset-url">${truncateUrl(a.source)}</a>
                                    </div>
                                    <div class="source-asset-actions">
                                        ${a.gcsPath ? `
                                            <button class="btn-icon" onclick="viewSourceDocument('${a.gcsPath}')" title="View">üëÅÔ∏è</button>
                                            <a href="/api/download/${a.gcsPath}" class="btn-icon" title="Download">‚¨áÔ∏è</a>
                                        ` : ''}
                                        <button class="btn-icon" onclick="deleteItem('assets', '${a.id}')" title="Delete">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                ${regularAssets.map(a => `
                    <div class="card">
                        <div class="item-header">
                            <div class="flex-1">
                                <div class="flex gap-2 mb-1 items-center">
                                    <h3>${a.title}</h3>
                                    <span class="badge badge-gray">${a.type}</span>
                                </div>
                                <p class="text-sm">Source: ${a.source}</p>
                                <span class="badge badge-orange mt-2">${a.status}</span>
                                ${a.notes ? `<p class="text-sm mt-2">${a.notes}</p>` : ''}
                            </div>
                            <div class="item-actions">
                                <button class="btn-icon" onclick="showEditModal('asset', '${a.id}')">‚úèÔ∏è</button>
                                <button class="btn-icon" onclick="deleteItem('assets', '${a.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderScripts() {
            // Episodes without scripts
            const episodesWithScripts = new Set(state.scripts.map(s => s.episodeId));
            const episodesWithoutScripts = state.episodes.filter(e => !episodesWithScripts.has(e.id));

            return `
                <div class="section-header">
                    <h2>Scripts</h2>
                    <p class="text-muted">Generate Quickture-compatible documentary scripts for each episode</p>
                </div>

                ${episodesWithoutScripts.length > 0 ? `
                    <div class="card">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <h3>Generate Scripts</h3>
                                <p class="text-muted">Select an episode or generate all at once:</p>
                            </div>
                            ${episodesWithoutScripts.length > 1 ? `
                                <button class="ai-button" id="generate-all-btn" onclick="generateAllScripts()">
                                    ‚ú® Generate All Scripts (${episodesWithoutScripts.length})
                                </button>
                            ` : ''}
                        </div>
                        <div class="episode-list">
                            ${episodesWithoutScripts.map(ep => `
                                <div class="episode-item" style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4>${ep.title}</h4>
                                        <p class="text-muted">${ep.description || 'No description'}</p>
                                    </div>
                                    <button class="ai-button" onclick="generateScript('${ep.id}', '${ep.title.replace(/'/g, "\\'")}')">
                                        Generate Script
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                ${state.scripts.length > 0 ? `
                    <div class="section-header mt-4" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Generated Scripts (${state.scripts.length})</h3>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-secondary" onclick="downloadAllScripts()">
                                üì• Download All
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="exportForQuickture()">
                                üé¨ Export for Quickture
                            </button>
                        </div>
                    </div>
                    ${state.scripts.map(s => {
                        const episode = state.episodes.find(e => e.id === s.episodeId);
                        return `
                            <div class="card">
                                <div class="item-header">
                                    <div class="flex-1">
                                        ${episode ? `<div class="text-xs mb-1" style="color: #2563eb;">${episode.title}</div>` : ''}
                                        <h3>${s.title}</h3>
                                        <div class="flex gap-2 mt-2">
                                            <span class="badge badge-gray">${s.format || 'quickture'}</span>
                                            <span class="badge badge-blue">${s.status || 'Draft'}</span>
                                            ${s.duration ? `<span class="badge badge-gray">${s.duration}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="item-actions">
                                        <button class="btn btn-sm btn-secondary" onclick="viewScript('${s.id}')">View</button>
                                        <button class="btn btn-sm btn-secondary" onclick="downloadScript('${s.id}')">Export</button>
                                        <button class="btn-icon" onclick="deleteItem('scripts', '${s.id}')">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                ` : state.episodes.length === 0 ? `
                    <div class="card">
                        <p class="text-muted">Create episodes first to generate scripts.</p>
                    </div>
                ` : ''}
            `;
        }

        async function generateScript(episodeId, episodeTitle) {
            const episode = state.episodes.find(e => e.id === episodeId);
            if (!episode) return;

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-small"></span> Generating...';

            try {
                const response = await fetch('/api/ai/generate-script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        episodeId: episode.id,
                        episodeTitle: episode.title,
                        episodeDescription: episode.description || '',
                        projectId: state.selectedProject,
                        projectTitle: state.project.title,
                        projectDescription: state.project.description || '',
                        projectStyle: state.project.style || '',
                        duration: episode.duration || '45 minutes'
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Reload scripts
                state.scripts = await api(`/api/projects/${state.selectedProject}/scripts`);
                render();

                // Show the generated script
                if (data.scriptId) {
                    viewScript(data.scriptId);
                }

            } catch (error) {
                alert('Error generating script: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Generate Script';
            }
        }

        function viewScript(scriptId) {
            const script = state.scripts.find(s => s.id === scriptId);
            if (!script) return;

            const episode = state.episodes.find(e => e.id === script.episodeId);

            showModal(script.title, `
                <div class="script-viewer">
                    ${episode ? `<div class="text-muted mb-2">Episode: ${episode.title}</div>` : ''}
                    <div class="flex gap-2 mb-3">
                        <span class="badge badge-gray">${script.format || 'quickture'}</span>
                        <span class="badge badge-blue">${script.status || 'Draft'}</span>
                    </div>
                    <div class="script-content-full">${marked.parse(script.content || '')}</div>
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-primary" onclick="downloadScript('${scriptId}')">Export as Text</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `);
        }

        function downloadScript(scriptId) {
            const script = state.scripts.find(s => s.id === scriptId);
            if (!script) return;

            // Create downloadable text file
            const blob = new Blob([script.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${script.title.replace(/[^a-z0-9]/gi, '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function generateAllScripts() {
            const episodesWithScripts = new Set(state.scripts.map(s => s.episodeId));
            const episodesWithoutScripts = state.episodes.filter(e => !episodesWithScripts.has(e.id));

            if (episodesWithoutScripts.length === 0) {
                alert('All episodes already have scripts!');
                return;
            }

            const btn = document.getElementById('generate-all-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-small"></span> Generating...';
            }

            let completed = 0;
            let errors = 0;

            // Show progress modal
            showModal('Generating All Scripts', `
                <div class="text-center">
                    <div class="spinner mb-3"></div>
                    <p id="gen-progress">Generating script 1 of ${episodesWithoutScripts.length}...</p>
                    <div class="progress-bar mt-3">
                        <div id="gen-progress-bar" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            `);

            for (const episode of episodesWithoutScripts) {
                try {
                    const progressEl = document.getElementById('gen-progress');
                    const progressBar = document.getElementById('gen-progress-bar');
                    if (progressEl) progressEl.textContent = `Generating: ${episode.title.substring(0, 40)}...`;

                    const response = await fetch('/api/ai/generate-script', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            episodeId: episode.id,
                            episodeTitle: episode.title,
                            episodeDescription: episode.description || '',
                            projectId: state.selectedProject,
                            projectTitle: state.project.title,
                            projectDescription: state.project.description || '',
                            projectStyle: state.project.style || '',
                            duration: episode.duration || '45 minutes'
                        })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    completed++;
                    if (progressBar) progressBar.style.width = `${(completed / episodesWithoutScripts.length) * 100}%`;

                } catch (error) {
                    console.error(`Error generating script for ${episode.title}:`, error);
                    errors++;
                }
            }

            // Reload scripts
            state.scripts = await api(`/api/projects/${state.selectedProject}/scripts`);
            closeModal();
            render();

            // Show result
            if (errors > 0) {
                alert(`Generated ${completed} scripts. ${errors} failed.`);
            } else {
                alert(`Successfully generated ${completed} scripts!`);
            }
        }

        function downloadAllScripts() {
            if (state.scripts.length === 0) {
                alert('No scripts to download');
                return;
            }

            // Create combined document
            const projectTitle = state.project.title || 'Documentary';
            let combined = `# ${projectTitle} - Complete Scripts\n`;
            combined += `Generated: ${new Date().toLocaleDateString()}\n`;
            combined += `Total Episodes: ${state.scripts.length}\n\n`;
            combined += '‚ïê'.repeat(80) + '\n\n';

            state.scripts.forEach((script, index) => {
                const episode = state.episodes.find(e => e.id === script.episodeId);
                combined += `## Episode ${index + 1}: ${episode?.title || script.title}\n\n`;
                combined += script.content || '';
                combined += '\n\n' + '‚îÄ'.repeat(80) + '\n\n';
            });

            // Download as single file
            const blob = new Blob([combined], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectTitle.replace(/[^a-z0-9]/gi, '_')}_All_Scripts.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportForQuickture() {
            if (state.scripts.length === 0) {
                alert('No scripts to export');
                return;
            }

            // Create Quickture-optimized export with metadata
            const projectTitle = state.project.title || 'Documentary';

            let exportData = {
                project: {
                    title: projectTitle,
                    description: state.project.description || '',
                    style: state.project.style || '',
                    exportDate: new Date().toISOString()
                },
                episodes: []
            };

            // Create structured data for each episode
            state.scripts.forEach((script, index) => {
                const episode = state.episodes.find(e => e.id === script.episodeId);

                // Parse scenes from script content
                const scenes = parseScenes(script.content || '');

                exportData.episodes.push({
                    number: index + 1,
                    title: episode?.title || script.title,
                    description: episode?.description || '',
                    duration: script.duration || '45 minutes',
                    scenes: scenes,
                    fullScript: script.content || ''
                });
            });

            // Create markdown version optimized for Quickture workflow
            let quicktureDoc = `# QUICKTURE PRODUCTION GUIDE\n`;
            quicktureDoc += `## Project: ${projectTitle}\n\n`;
            quicktureDoc += `**Style:** ${state.project.style || 'Documentary'}\n`;
            quicktureDoc += `**Export Date:** ${new Date().toLocaleDateString()}\n\n`;
            quicktureDoc += `---\n\n`;
            quicktureDoc += `## QUICK REFERENCE: SHOT LIST\n\n`;

            // Generate consolidated shot list
            exportData.episodes.forEach((ep, i) => {
                quicktureDoc += `### Episode ${i + 1}: ${ep.title}\n\n`;
                ep.scenes.forEach(scene => {
                    quicktureDoc += `**${scene.name}** (${scene.duration || 'TBD'})\n`;
                    if (scene.broll && scene.broll.length > 0) {
                        scene.broll.forEach(shot => quicktureDoc += `  - [ ] ${shot}\n`);
                    }
                    quicktureDoc += '\n';
                });
            });

            quicktureDoc += `---\n\n## FULL SCRIPTS\n\n`;

            state.scripts.forEach((script, index) => {
                const episode = state.episodes.find(e => e.id === script.episodeId);
                quicktureDoc += `### Episode ${index + 1}: ${episode?.title || script.title}\n\n`;
                quicktureDoc += script.content || '';
                quicktureDoc += '\n\n---\n\n';
            });

            // Download the Quickture guide
            const blob = new Blob([quicktureDoc], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectTitle.replace(/[^a-z0-9]/gi, '_')}_Quickture_Guide.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Also offer JSON export
            setTimeout(() => {
                if (confirm('Also download structured JSON data for advanced workflows?')) {
                    const jsonBlob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const jsonUrl = URL.createObjectURL(jsonBlob);
                    const jsonA = document.createElement('a');
                    jsonA.href = jsonUrl;
                    jsonA.download = `${projectTitle.replace(/[^a-z0-9]/gi, '_')}_Quickture_Data.json`;
                    document.body.appendChild(jsonA);
                    jsonA.click();
                    document.body.removeChild(jsonA);
                    URL.revokeObjectURL(jsonUrl);
                }
            }, 500);
        }

        function parseScenes(scriptContent) {
            // Parse scene structure from script markdown
            const scenes = [];
            const sceneRegex = /SCENE\s+(\d+)[:\s]+([^\n]+)/gi;
            const brollRegex = /B-ROLL NEEDED:([^]*?)(?=\n(?:SCENE|GRAPHICS|INTERVIEW|NARRATION|$))/gi;

            let match;
            while ((match = sceneRegex.exec(scriptContent)) !== null) {
                const sceneNum = match[1];
                const sceneName = match[2].trim();

                // Find B-roll for this scene
                const sceneStart = match.index;
                const nextScene = scriptContent.indexOf('SCENE', sceneStart + 10);
                const sceneContent = scriptContent.substring(sceneStart, nextScene > 0 ? nextScene : undefined);

                const broll = [];
                const brollMatch = /B-ROLL NEEDED:\s*\n([\s\S]*?)(?=\n\s*\n|\n[A-Z]+:|$)/i.exec(sceneContent);
                if (brollMatch) {
                    const brollLines = brollMatch[1].split('\n');
                    brollLines.forEach(line => {
                        const cleaned = line.replace(/^[\s\-\*]+/, '').trim();
                        if (cleaned && cleaned.length > 2) {
                            broll.push(cleaned);
                        }
                    });
                }

                // Find duration
                const durationMatch = /Duration:\s*([^\n]+)/i.exec(sceneContent);

                scenes.push({
                    number: parseInt(sceneNum),
                    name: `Scene ${sceneNum}: ${sceneName}`,
                    duration: durationMatch ? durationMatch[1].trim() : null,
                    broll: broll
                });
            }

            return scenes;
        }

        // ============== Feedback Functions ==============

        let feedbackScreenshot = null;
        let speechRecognition = null;
        let isRecording = false;

        async function openFeedback() {
            // Hide the feedback button while modal is open
            document.getElementById('feedback-btn').style.display = 'none';

            // Show modal immediately with loading state
            document.getElementById('feedback-modal').classList.add('active');
            document.getElementById('feedback-screenshot-preview').innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Capturing screenshot...</p>
                </div>
            `;

            // Clear previous input
            document.getElementById('feedback-text').value = '';
            document.querySelector('input[name="feedback-type"][value="bug"]').checked = true;

            // Capture screenshot
            try {
                // Hide feedback button and modal temporarily for clean screenshot
                document.getElementById('feedback-modal').style.visibility = 'hidden';

                const canvas = await html2canvas(document.body, {
                    scale: 0.5,  // Reduce size for faster upload
                    useCORS: true,
                    logging: false,
                    backgroundColor: getComputedStyle(document.body).backgroundColor
                });

                feedbackScreenshot = canvas.toDataURL('image/jpeg', 0.7);

                // Show screenshot preview
                document.getElementById('feedback-screenshot-preview').innerHTML = `
                    <img src="${feedbackScreenshot}" alt="Screenshot" class="screenshot-img">
                `;

                document.getElementById('feedback-modal').style.visibility = 'visible';

            } catch (error) {
                console.error('Screenshot error:', error);
                document.getElementById('feedback-screenshot-preview').innerHTML = `
                    <div class="text-muted">Screenshot capture failed - feedback will be sent without image</div>
                `;
                document.getElementById('feedback-modal').style.visibility = 'visible';
            }
        }

        function closeFeedbackModal() {
            document.getElementById('feedback-modal').classList.remove('active');
            document.getElementById('feedback-btn').style.display = 'flex';
            stopVoiceInput();
            feedbackScreenshot = null;
        }

        function toggleVoiceInput() {
            if (isRecording) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        function startVoiceInput() {
            // Check for browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                alert('Voice input is not supported in this browser. Try Chrome or Edge.');
                return;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';

            const voiceBtn = document.getElementById('voice-btn');
            const voiceStatus = document.getElementById('voice-status');
            const feedbackText = document.getElementById('feedback-text');

            speechRecognition.onstart = () => {
                isRecording = true;
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '‚èπÔ∏è';
                voiceStatus.textContent = 'üî¥ Listening... (click to stop)';
                voiceStatus.classList.add('active');
            };

            speechRecognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    feedbackText.value += finalTranscript;
                }

                if (interimTranscript) {
                    voiceStatus.textContent = `üî¥ "${interimTranscript}"`;
                }
            };

            speechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access to use voice input.');
                }
                stopVoiceInput();
            };

            speechRecognition.onend = () => {
                // Restart if still recording (auto-stop after silence)
                if (isRecording) {
                    try {
                        speechRecognition.start();
                    } catch (e) {
                        stopVoiceInput();
                    }
                }
            };

            try {
                speechRecognition.start();
            } catch (error) {
                console.error('Failed to start speech recognition:', error);
                alert('Failed to start voice input. Please try again.');
            }
        }

        function stopVoiceInput() {
            isRecording = false;
            const voiceBtn = document.getElementById('voice-btn');
            const voiceStatus = document.getElementById('voice-status');

            voiceBtn.classList.remove('recording');
            voiceBtn.innerHTML = 'üé§';
            voiceStatus.textContent = '';
            voiceStatus.classList.remove('active');

            if (speechRecognition) {
                speechRecognition.stop();
                speechRecognition = null;
            }
        }

        async function submitFeedback() {
            const feedbackText = document.getElementById('feedback-text').value.trim();
            const feedbackType = document.querySelector('input[name="feedback-type"]:checked').value;

            if (!feedbackText) {
                alert('Please enter your feedback');
                return;
            }

            const submitBtn = document.getElementById('submit-feedback-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-small"></span> Sending...';

            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: feedbackText,
                        type: feedbackType,
                        screenshot: feedbackScreenshot,
                        projectId: state.selectedProject,
                        projectTitle: state.project?.title || null,
                        currentTab: state.activeTab,
                        userAgent: navigator.userAgent,
                        screenSize: `${window.innerWidth}x${window.innerHeight}`,
                        timestamp: new Date().toISOString()
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                closeFeedbackModal();
                alert('Thank you for your feedback! üôè');

            } catch (error) {
                console.error('Feedback submission error:', error);
                alert('Failed to send feedback: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Feedback';
            }
        }

        // ============== Modal Functions ==============

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showAddModal(type) {
            const forms = {
                episode: `
                    <form onsubmit="saveItem(event, 'episodes')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <input type="text" name="title" placeholder="Episode title" required>
                        <textarea name="description" placeholder="Description" rows="3"></textarea>
                        <input type="text" name="duration" placeholder="Duration (e.g., 45 min)">
                        <select name="status">
                            <option value="Planning">Planning</option>
                            <option value="Research">Research</option>
                            <option value="Scripting">Scripting</option>
                            <option value="Production">Production</option>
                            <option value="Post-Production">Post-Production</option>
                            <option value="Complete">Complete</option>
                        </select>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `,
                research: `
                    <form onsubmit="saveItem(event, 'research')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <input type="text" name="title" placeholder="Title" required>
                        <textarea name="content" placeholder="Research notes" rows="5" required></textarea>
                        <select name="category">
                            <option value="General">General</option>
                            <option value="Archive">Archive</option>
                            <option value="Background">Background</option>
                            <option value="Contact">Contact</option>
                            <option value="Location">Location</option>
                        </select>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `,
                interview: `
                    <form onsubmit="saveItem(event, 'interviews')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <input type="text" name="subject" placeholder="Subject name" required>
                        <input type="text" name="role" placeholder="Role/Title">
                        <select name="status">
                            <option value="Potential">Potential</option>
                            <option value="Requested">Requested</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <textarea name="questions" placeholder="Interview questions" rows="4"></textarea>
                        <textarea name="notes" placeholder="Notes" rows="2"></textarea>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `,
                shot: `
                    <form onsubmit="saveItem(event, 'shots')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <textarea name="description" placeholder="Shot description" rows="3" required></textarea>
                        <input type="text" name="location" placeholder="Location">
                        <input type="text" name="equipment" placeholder="Equipment needed">
                        <input type="date" name="shootDate">
                        <select name="status">
                            <option value="Pending">Pending</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Shot">Shot</option>
                            <option value="Edited">Edited</option>
                        </select>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `,
                asset: `
                    <form onsubmit="saveItem(event, 'assets')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <input type="text" name="title" placeholder="Asset title" required>
                        <select name="type">
                            <option value="Video">Video</option>
                            <option value="Audio">Audio</option>
                            <option value="Image">Image</option>
                            <option value="Document">Document</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="text" name="source" placeholder="Source">
                        <select name="status">
                            <option value="Needed">Needed</option>
                            <option value="Licensing">Licensing</option>
                            <option value="Acquired">Acquired</option>
                            <option value="Processed">Processed</option>
                        </select>
                        <textarea name="notes" placeholder="Notes" rows="2"></textarea>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `,
                script: `
                    <form onsubmit="saveItem(event, 'scripts')">
                        <input type="hidden" name="projectId" value="${state.selectedProject}">
                        <input type="text" name="title" placeholder="Script title" required>
                        <textarea name="content" placeholder="Script content" rows="10" required></textarea>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `
            };

            const titles = {
                episode: 'Add Episode',
                research: 'Add Research',
                interview: 'Add Interview',
                shot: 'Add Shot',
                asset: 'Add Asset',
                script: 'Add Script'
            };

            showModal(titles[type], forms[type]);
        }

        function showEditModal(type, id) {
            const collectionMap = {
                episode: 'episodes',
                research: 'research',
                interview: 'interviews',
                shot: 'shots',
                asset: 'assets',
                script: 'scripts'
            };

            const item = state[collectionMap[type]].find(i => i.id === id);
            if (!item) return;

            // Simplified - show add modal with prefilled data
            showAddModal(type);

            // Fill in form data after a short delay
            setTimeout(() => {
                const form = document.querySelector('#modal-body form');
                if (form) {
                    form.dataset.editId = id;
                    form.dataset.editType = collectionMap[type];

                    Object.keys(item).forEach(key => {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) input.value = item[key] || '';
                    });
                }
            }, 50);
        }

        async function saveItem(event, collection) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const editId = form.dataset.editId;
                const editType = form.dataset.editType;

                if (editId && editType) {
                    // Update existing
                    await api(`/api/${editType}/${editId}`, 'PUT', data);
                } else {
                    // Create new
                    await api(`/api/${collection}`, 'POST', data);
                }

                closeModal();
                await loadProjectData();
            } catch (error) {
                alert('Error saving: ' + error.message);
            }
        }

        async function deleteItem(collection, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            try {
                await api(`/api/${collection}/${id}`, 'DELETE');
                await loadProjectData();
            } catch (error) {
                alert('Error deleting: ' + error.message);
            }
        }

        // ============== AI Modal Functions ==============

        function showAIModal(type, context = {}) {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');

            const templates = {
                research: `
                    <div class="ai-section">
                        <h4>üîç Research Assistant</h4>
                        <p class="text-sm text-muted mb-3">Get help finding sources, contacts, and background information.</p>
                        <div class="input-with-mic">
                            <textarea id="ai-query" class="ai-input" rows="3" placeholder="What do you need research help with?"></textarea>
                            <button type="button" class="mic-btn" data-for="ai-query" onclick="toggleSpeech('ai-query')" title="Speak">üé§</button>
                        </div>
                        <button class="ai-button" onclick="runAI('research')" id="ai-btn">‚ú® Get Research Help</button>
                        <div id="ai-result"></div>
                    </div>
                `,
                interview: `
                    <div class="ai-section">
                        <h4>üí¨ Interview Question Generator</h4>
                        <p class="text-sm text-muted mb-3">Generate thoughtful interview questions.</p>
                        <div class="input-with-mic">
                            <input id="ai-subject" class="ai-input" placeholder="Subject name">
                            <button type="button" class="mic-btn" data-for="ai-subject" onclick="toggleSpeech('ai-subject')" title="Speak">üé§</button>
                        </div>
                        <div class="input-with-mic">
                            <input id="ai-role" class="ai-input" placeholder="Their role">
                            <button type="button" class="mic-btn" data-for="ai-role" onclick="toggleSpeech('ai-role')" title="Speak">üé§</button>
                        </div>
                        <div class="input-with-mic">
                            <textarea id="ai-context" class="ai-input" rows="2" placeholder="What aspects to explore?"></textarea>
                            <button type="button" class="mic-btn" data-for="ai-context" onclick="toggleSpeech('ai-context')" title="Speak">üé§</button>
                        </div>
                        <button class="ai-button" onclick="runAI('interview')" id="ai-btn">‚ú® Generate Questions</button>
                        <div id="ai-result"></div>
                    </div>
                `,
                script: `
                    <div class="ai-section">
                        <h4>üìù Script Outline Generator</h4>
                        <p class="text-sm text-muted mb-3">Create a structured outline for your episode.</p>
                        <div class="input-with-mic">
                            <input id="ai-title" class="ai-input" placeholder="Episode title" value="${context.title || ''}">
                            <button type="button" class="mic-btn" data-for="ai-title" onclick="toggleSpeech('ai-title')" title="Speak">üé§</button>
                        </div>
                        <div class="input-with-mic">
                            <textarea id="ai-topic" class="ai-input" rows="3" placeholder="What should this episode cover?"></textarea>
                            <button type="button" class="mic-btn" data-for="ai-topic" onclick="toggleSpeech('ai-topic')" title="Speak">üé§</button>
                        </div>
                        <input id="ai-duration" class="ai-input" placeholder="Target duration (e.g., 45 minutes)">
                        <button class="ai-button" onclick="runAI('script')" id="ai-btn">‚ú® Generate Outline</button>
                        <div id="ai-result"></div>
                    </div>
                `,
                'shot-ideas': `
                    <div class="ai-section">
                        <h4>üé¨ Shot List Ideas</h4>
                        <p class="text-sm text-muted mb-3">Get creative shot ideas for your documentary.</p>
                        <div class="input-with-mic">
                            <textarea id="ai-scene" class="ai-input" rows="3" placeholder="Describe the scene or topic"></textarea>
                            <button type="button" class="mic-btn" data-for="ai-scene" onclick="toggleSpeech('ai-scene')" title="Speak">üé§</button>
                        </div>
                        <button class="ai-button" onclick="runAI('shot-ideas')" id="ai-btn">‚ú® Get Shot Ideas</button>
                        <div id="ai-result"></div>
                    </div>
                `,
                'expand-topic': `
                    <div class="ai-section">
                        <h4>üí° Topic Expansion</h4>
                        <p class="text-sm text-muted mb-3">Explore angles, themes, and storylines.</p>
                        <div class="input-with-mic">
                            <textarea id="ai-topic" class="ai-input" rows="3" placeholder="What topic to explore?">${context.topic || ''}</textarea>
                            <button type="button" class="mic-btn" data-for="ai-topic" onclick="toggleSpeech('ai-topic')" title="Speak">üé§</button>
                        </div>
                        <label class="checkbox-label">
                            <input type="checkbox" id="ai-use-project-context" ${context.topic ? 'checked' : ''}>
                            <span>Include project context (${state.project?.title || 'current project'})</span>
                        </label>
                        <button class="ai-button" onclick="runAI('expand-topic')" id="ai-btn">‚ú® Expand Topic</button>
                        <div id="ai-result"></div>
                    </div>
                `
            };

            content.innerHTML = templates[type] || '';
            content.dataset.aiType = type;
            modal.classList.add('active');
        }

        function closeAIModal() {
            document.getElementById('ai-modal').classList.remove('active');
        }

        async function runAI(type) {
            const btn = document.getElementById('ai-btn');
            const resultDiv = document.getElementById('ai-result');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-small"></span> Processing...';
            resultDiv.innerHTML = '';

            try {
                let endpoint, body;
                const projectTitle = state.project?.title || '';

                switch(type) {
                    case 'research':
                        endpoint = '/api/ai/research';
                        body = {
                            query: document.getElementById('ai-query').value,
                            projectContext: `${projectTitle} - ${state.project?.description || ''}`,
                            projectId: state.selectedProject,
                            downloadSources: true
                        };
                        break;
                    case 'interview':
                        endpoint = '/api/ai/interview-questions';
                        body = {
                            subject: document.getElementById('ai-subject').value,
                            role: document.getElementById('ai-role').value,
                            context: document.getElementById('ai-context').value,
                            projectTitle
                        };
                        break;
                    case 'script':
                        endpoint = '/api/ai/script-outline';
                        body = {
                            title: document.getElementById('ai-title').value,
                            topic: document.getElementById('ai-topic').value,
                            duration: document.getElementById('ai-duration').value || '45 minutes',
                            projectTitle
                        };
                        break;
                    case 'shot-ideas':
                        endpoint = '/api/ai/shot-ideas';
                        body = {
                            scene: document.getElementById('ai-scene').value,
                            projectTitle
                        };
                        break;
                    case 'expand-topic':
                        endpoint = '/api/ai/expand-topic';
                        const useProjectContext = document.getElementById('ai-use-project-context')?.checked;
                        body = {
                            topic: document.getElementById('ai-topic').value,
                            projectTitle: useProjectContext ? projectTitle : ''
                        };
                        break;
                }

                const response = await api(endpoint, 'POST', body);

                // Build source documents section for research
                let sourcesHtml = '';
                if (type === 'research' && response.sources && response.sources.length > 0) {
                    sourcesHtml = `
                        <div class="source-docs-section">
                            <h4>üìÑ Archived Source Documents (${response.sources.length})</h4>
                            <div class="source-docs-list">
                                ${response.sources.map(src => `
                                    <div class="source-doc-item">
                                        <div class="source-doc-info">
                                            <span class="source-doc-title">${src.title || 'Document'}</span>
                                            <a href="${src.url}" target="_blank" class="source-doc-url">${truncateUrl(src.url)}</a>
                                        </div>
                                        <div class="source-doc-actions">
                                            ${src.gcsPath ? `
                                                <button class="btn-icon" onclick="viewSourceDocument('${src.gcsPath}')" title="View">üëÅÔ∏è</button>
                                                <a href="/api/download/${src.gcsPath}" class="btn-icon" title="Download">‚¨áÔ∏è</a>
                                            ` : `<span class="badge badge-gray">${src.status}</span>`}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <p class="text-sm text-muted mt-2">Sources added to Assets tab for verification.</p>
                        </div>
                    `;
                }

                resultDiv.innerHTML = `
                    <div class="ai-result">
                        <div class="ai-result-content">${marked.parse(response.result)}</div>
                        <div class="ai-result-raw" style="display:none;">${response.result}</div>
                        ${sourcesHtml}
                        ${type === 'research' ? `
                            <button class="btn btn-primary mt-3" onclick="saveAIAsResearch()">üíæ Save as Research Note</button>
                        ` : ''}
                        ${type === 'interview' ? `
                            <button class="btn btn-primary mt-3" onclick="saveAIAsInterview()">üíæ Save as Interview</button>
                        ` : ''}
                        ${type === 'script' ? `
                            <button class="btn btn-primary mt-3" onclick="saveAIAsScript()">üíæ Save as Script</button>
                        ` : ''}
                        ${type === 'expand-topic' ? `
                            <button class="btn btn-primary mt-3" onclick="saveAIAsResearchFromTopic()">üíæ Save as Research Note</button>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error-card">Error: ${error.message}</div>`;
            }

            btn.disabled = false;
            btn.innerHTML = '‚ú® Try Again';
        }

        async function saveAIAsResearch() {
            const query = document.getElementById('ai-query').value;
            const result = document.querySelector('#ai-result .ai-result-raw').textContent;

            await api('/api/research', 'POST', {
                projectId: state.selectedProject,
                title: query.substring(0, 100),
                content: result,
                category: 'AI Generated'
            });

            closeAIModal();
            state.activeTab = 'research';
            await loadProjectData();
        }

        async function saveAIAsInterview() {
            const subject = document.getElementById('ai-subject').value;
            const role = document.getElementById('ai-role').value;
            const result = document.querySelector('#ai-result .ai-result-raw').textContent;

            await api('/api/interviews', 'POST', {
                projectId: state.selectedProject,
                subject,
                role,
                status: 'Potential',
                questions: result,
                notes: 'Generated by AI'
            });

            closeAIModal();
            state.activeTab = 'interviews';
            await loadProjectData();
        }

        async function saveAIAsScript() {
            const title = document.getElementById('ai-title').value;
            const result = document.querySelector('#ai-result .ai-result-raw').textContent;

            await api('/api/scripts', 'POST', {
                projectId: state.selectedProject,
                title,
                content: result
            });

            closeAIModal();
            state.activeTab = 'scripts';
            await loadProjectData();
        }

        async function saveAIAsResearchFromTopic() {
            const topic = document.getElementById('ai-topic').value;
            const result = document.querySelector('#ai-result .ai-result-raw').textContent;

            await api('/api/research', 'POST', {
                projectId: state.selectedProject,
                title: `Topic Exploration: ${topic.substring(0, 80)}`,
                content: result,
                category: 'AI Generated'
            });

            closeAIModal();
            state.activeTab = 'research';
            await loadProjectData();
        }

        // ============== Speech Recognition ==============

        let recognition = null;
        let isListening = false;

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    const targetInput = document.querySelector('[data-speech-target]');
                    if (targetInput) {
                        targetInput.value = transcript;
                    }
                };

                recognition.onend = () => {
                    isListening = false;
                    updateMicButtons();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    updateMicButtons();
                    if (event.error === 'not-allowed') {
                        alert('Microphone access denied. Please allow microphone access to use speech input.');
                    }
                };

                return true;
            }
            return false;
        }

        function toggleSpeech(inputId) {
            if (!recognition && !initSpeechRecognition()) {
                alert('Speech recognition is not supported in your browser. Try Chrome or Edge.');
                return;
            }

            // Remove previous target
            document.querySelectorAll('[data-speech-target]').forEach(el => el.removeAttribute('data-speech-target'));

            const input = document.getElementById(inputId);
            if (!input) return;

            if (isListening) {
                recognition.stop();
                isListening = false;
            } else {
                input.setAttribute('data-speech-target', 'true');
                recognition.start();
                isListening = true;
            }
            updateMicButtons();
        }

        function updateMicButtons() {
            document.querySelectorAll('.mic-btn').forEach(btn => {
                if (isListening && btn.dataset.for === document.querySelector('[data-speech-target]')?.id) {
                    btn.classList.add('listening');
                    btn.innerHTML = 'üî¥';
                } else {
                    btn.classList.remove('listening');
                    btn.innerHTML = 'üé§';
                }
            });
        }

        // ============== Source Document Functions ==============

        function truncateUrl(url) {
            if (!url) return '';
            try {
                const urlObj = new URL(url);
                const path = urlObj.pathname.length > 20 ? urlObj.pathname.substring(0, 20) + '...' : urlObj.pathname;
                return urlObj.hostname + path;
            } catch {
                return url.length > 40 ? url.substring(0, 40) + '...' : url;
            }
        }

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function viewSourceDocument(path) {
            window.open(`/api/document/${path}`, '_blank');
        }

        async function clearAllSourceDocuments() {
            const sourceCount = state.assets.filter(a => a.isSourceDocument).length;
            if (!confirm(`Are you sure you want to delete all ${sourceCount} source documents?\n\nThis will permanently remove all archived research sources for this project.`)) {
                return;
            }

            try {
                const result = await api(`/api/projects/${state.selectedProject}/assets/clear-sources`, 'DELETE');
                await loadProjectData();
                alert(`Deleted ${result.deleted} source document(s).`);
            } catch (error) {
                alert('Error clearing source documents: ' + error.message);
            }
        }

        // ============== Theme Toggle ==============

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        }

        function updateThemeButton(theme) {
            const btn = document.getElementById('theme-btn');
            if (btn) {
                btn.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                btn.title = theme === 'light' ? 'Switch to dark mode' : 'Switch to light mode';
            }
        }

        // ============== Initialize ==============

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            renderNav();
            loadProjectData();
        });
    </script>
</body>
</html>
